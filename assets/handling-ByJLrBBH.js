import{e as y,g as L,i as b,v as I,w as A,l as O,x as D,y as N,o as H}from"./templates-BHc6gmku.js";import{s as T,c as J,p as G,e as q,u as E,b as B,f as C,h as F,i as R,j as V,k as z}from"./async-D39189Bj.js";import{aT as w,Y as x,n as U,L as K,aU as M,aV as S,aW as Q,aX as W,aY as Y,aZ as _}from"./main-LWPQBhI8.js";async function X({links:e,jsonformValue:n,specUrl:a,customEndpointsHandler:t,jsonformSchema:r,selectedStac:o,isPolling:c,jobs:u,enableCompare:d=!1}){if(!a||!e)return[null,null];const i=await y.get(a).then(p=>p.data),s={},[f,l]=T(e,"service",void 0),h=t&&n&&await t({jsonformSchema:r,jsonformValue:n,links:l,selectedStac:o,isPolling:c,jobs:u,enableCompare:d});if(h&&h.length)return i.data.values=h,[i,s];const g=f.filter(p=>p.rel==="service");try{e:for(const p of g??[])switch(p.type){case void 0:continue;case"application/json":await Z(i,{url:p.href,jsonformValue:n,link:p,flatstyleUrl:p["eox:flatstyle"],jsonformSchema:r});break e;case"text/csv":await $(i,{url:p.href,jsonformValue:n,flatstyleUrl:p["eox:flatstyle"]});break e;default:break}}catch(p){console.error("[eodash] Error while injecting Vega data",p)}return[i,s]}async function Z(e,{url:n,jsonformValue:a,link:t,flatstyleUrl:r,jsonformSchema:o}){if(e.data){if(t.method=="GET"){const c=o?.options?.multiQuery,u=Object.keys(a??{}).filter(i=>Array.isArray(c)?c.includes(i):c===i);if(u.length>0&&a){const i=[];for(const s of u)if(Array.isArray(a[s]))for(const f of a[s]){const l=await k(n,{...a,[s]:f},r);i.push(await y.get(l).then(h=>h.data))}else{const f=await k(n,a,r);i.push(await y.get(f).then(l=>l.data))}return e.data.values=i.flat(),e}const d=await k(n,a,r);e.data.values=await y.get(d).then(i=>i.data)}else if(t.method=="POST"){if(!t.body)return console.error("[eodash] Inline data POST request requires a body template"),e;const c=await y.get(t.body,{responseType:"text"}).then(d=>d.data),u=JSON.parse(w.render(c,{...a??{}}));e.data.values=await y.post(n,u).then(d=>d.data)}return e}}async function $(e,{url:n,jsonformValue:a,flatstyleUrl:t}){if(!e.data)return;const r=await k(n,a,t);return e.data.url=r,e}async function k(e,n,a){let t={};return a&&(t=await y.get(a).then(r=>r.data)),w.render(e,{...n??{},...t})}async function j({links:e,jsonformValue:n,layerId:a,projection:t}){if(!e)return;const[r,o]=T(e,"service","image/tiff");if(!r.length)return;let c=[],u="";for(const i of r??[])c.push(w.render(i.href,{...n??{}}));return await Promise.all(r.map(i=>J(i,a,c,t,u))).then(i=>i.filter(s=>!!s))}function ee(e,n,a){if(!e)return;const t=e.filter(o=>o.rel==="service"&&o.type==="image/png"),r=[];for(const o of t)r.push({type:"Image",properties:{id:o.id+"_process",title:"Results "+o.id},source:{type:"ImageStatic",imageExtent:a,url:w.render(o.href,{...n??{}})}});return r}async function te(e,n,a){if(!e)return;const t=[],r=e.filter(c=>c.rel==="service"&&c.type==="application/geo+json");if(!r.length)return t;let o=null;for(const c of r){"eox:flatstyle"in(c??{})&&(o=await y.get(c["eox:flatstyle"]).then(s=>s.data));let u,d;if(o){const s=K(a??"",o);u=s.layerConfig,d=s.style}const i={type:"Vector",source:{type:"Vector",url:w.render(c.href,{...n??{}}),format:"GeoJSON"},properties:{id:c.id+"_process",title:"Results "+a,...u&&{...u}},...d&&{style:d}};t.push(i)}return t}async function ne({links:e,jsonformValue:n,layerId:a,projection:t,origBbox:r,isPolling:o,selectedStac:c,jsonformSchema:u,jobs:d,customLayersHandler:i,enableCompare:s=!1}){if(!e)return[];const f=[],[l,h]=T(e,"service",void 0);if(i&&n&&c&&u&&h.length>0){const v=await i({jsonformValue:n,links:h,selectedStac:c,isPolling:o,jsonformSchema:u,jobs:d,enableCompare:s});v.length&&f.push(...v)}const g=await te(l,n,a),p=ee(l,n,r),m=await j({links:l,jsonformValue:n,layerId:a,projection:t});return f.push(...g??[],...p??[],...m??[]),f}async function ae(e,n,a=!1){const t=e.find(u=>u.rel==="service"&&u.type=="application/json; profile=collection"&&u.endpoint==="STAC");if(!t)return;let r=w.render(t.href,{...n??{}});x.value&&(x.value=!1);const o=U();await(a?o.loadSelectedCompareSTAC:o.loadSelectedSTAC)(r,!0)}async function re({links:e,jsonformValue:n,isPolling:a,selectedStac:t,jobs:r,enableCompare:o=!1}){if(!a)return;const c=e.filter(d=>d.rel==="service"&&d.endpoint==="eoxhub_workspaces"),u=[];for(const d of c){const i=await y.get(d.body,{responseType:"text"}).then(l=>l.data),s=JSON.parse(w.render(i,{...n??{}})),f=o?L:b;try{const l=await y.post(d.href,s,{headers:{"Content-Type":"application/json"}}),h=JSON.parse(localStorage.getItem(f.value)||"[]");h.push(l.headers.location),localStorage.setItem(f.value,JSON.stringify(h));const g=await G({jobs:r,processUrl:l.headers.location,isPolling:a,enableCompare:o}).then(p=>q(p)).catch(p=>(p instanceof Error?console.error("Polling failed:",p.message):console.error("Unknown error occurred during polling:",p),[]));await E(r,f.value),u.push(...await B(g,d,t))}catch(l){await E(r,f.value),l instanceof Error?console.error("Error sending POST request:",l.message):console.error("Unknown error occurred:",l)}}return u}const oe=se([re]);function se(e){return async n=>await Promise.all(e.map(a=>a(n))).then(a=>{const t=[];for(const r of a)t.push(...r?.filter(ie)??[]);return t})}function ie(e){return!!e&&!!e.type&&(!!e.source||!!e.layers)}var P={};async function ce({links:e,jsonformValue:n,jsonformSchema:a,selectedStac:t,enableCompare:r=!1}){const o=e.find(g=>g.rel==="service"&&g.endpoint==="sentinelhub");if(!o)return;const c=await fe(t,r?I.value:A.value);if(!c){console.error("[eodash] evalscript link for sentinel hub not found in indicator",c);return}if(!o)return;const u=o.href,d=C(a),i=n[d],s=P.EODASH_SENTINELHUB_CLIENT_ID,f=P.EODASH_SENTINELHUB_CLIENT_SECRET,l=await le(s,f);if(!l){console.error("[eodash] Error while fetching bearer token from sentinel hub");return}const h=F(t.extent.temporal.interval[0],[n.start_date,n.end_date],n.distribution);return await Promise.all(h.map(([g,p])=>de({url:u,bearer:l,bbox:i,from:p,to:g,exampleLink:c}).catch(m=>console.error("[eodash] Error while fetching data from sentinel hub endpoint:",m)))).then(g=>g.flat().map(p=>p.outputs.data))}async function le(e,n){if(!e||!n){console.error("[eodash] Error (sentinelhub): client id or secret not found");return}const a=sessionStorage.getItem("sentinelhub_token"),t=sessionStorage.getItem("sentinelhub_token_time"),r=Date.now()-Number(t)<3600*1e3;if(a&&r)return sessionStorage.setItem("sentinelhub_token_time",Date.now().toString()),a;const o=await ue(e,n);if(o)return sessionStorage.setItem("sentinelhub_token_time",Date.now().toString()),sessionStorage.setItem("sentinelhub_token",o),o}async function ue(e,n){const a="https://services.sentinel-hub.com/oauth/token",t={"Content-Type":"application/x-www-form-urlencoded"},r=new URLSearchParams({client_id:e,client_secret:n,response_type:"token",grant_type:"client_credentials"});return await y.post(a,r,{headers:t}).then(o=>o.data.access_token)}async function de({url:e,bearer:n,bbox:a,from:t,to:r,timeout:o=2e4,exampleLink:c}){if(!c){console.error("[eodash] Error (sentinelhub): example link not found in indicator");return}if(!a){console.error("[eodash] Error (sentinelhub): bbox not found");return}if(!t||!r||new Date(t)>new Date(r)){console.error("[eodash] Error (sentinelhub): time range is faulty or not found",t,r);return}const u=await y.get(c.href,{responseType:"text"}).then(s=>s.data);if(!u||u.error){console.error("[eodash] Error (sentinelhub): evalscript not found",u);return}const d={input:{bounds:{bbox:a},data:[{dataFilter:{},type:c.dataId}]},aggregation:{evalscript:u,timeRange:{from:t,to:r},aggregationInterval:{of:"P1D"},width:100,height:100},calculations:{default:{}}},i={headers:{Authorization:`Bearer ${n}`,"Content-Type":"application/json"},params:{credentials:"same-origin"},timeout:o};return await y.post(e,d,i).then(s=>{const f=s.data.data;return f.forEach(l=>{l.outputs.data.date=t}),f}).catch(s=>{if(s.response?.status===401){console.error("[eodash] Error (sentinelhub): bearer token expired, please try again"),sessionStorage.removeItem("sentinelhub_token"),sessionStorage.removeItem("sentinelhub_token_time");return}return console.error("[eodash] Error (sentinelhub): error while fetching data from sentinel hub",s.response?.data),[]})}async function fe(e,n){const a=e.links.find(t=>t.rel==="example"&&t.title==="evalscript");if(a)return a;for(const t of M(e,n)){const r=y.get(t).then(o=>o.data.links.find(c=>c.rel==="example"&&c.title==="evalscript"));if(r)return r}}async function pe({links:e,jsonformSchema:n,jsonformValue:a,selectedStac:t,enableCompare:r=!1}){const o=e.find(s=>s.rel==="service"&&(s.endpoint==="veda"||s.endpoint==="veda_stac"));if(!o)return;const c=o?.href,u=C(n),d=JSON.parse(a[u]),i=await he(t,r?I.value:A.value,o);return await Promise.all(i.map(({endpoint:s,datetime:f})=>{const l=new URL(c),h=o.endpoint==="veda_stac"?"ids":"url";return l.searchParams.set(h,s),y.post(l.toString(),{type:"Feature",properties:{},geometry:d}).then(g=>{const p=g.data.properties.statistics;return p.date=f,p}).catch(g=>console.error("[eodash] Error while fetching data from veda endpoint:",g))}))}async function he(e,n,a){const t=e.links.filter(i=>i.rel=="child"),r=[];t.length?r.push(...await Promise.all(t.map(i=>y.get(S(i.href,n)).then(s=>s.data).then(async s=>{const f=Object.values(s.assets??{}).find(l=>l.type==="application/vnd.apache.parquet"&&l.roles?.includes("collection-mirror"));if(f){const l=S(f.href,S(i.href,n));await Q(l).then(h=>{s.links.push(...W(h))})}return s})))):r.push(e);const o=[];for(const i of r){const s=Y(i.links),f=i.links.filter(l=>l.rel=="item");o.push(...f.map(l=>({endpoint:a.endpoint==="veda_stac"?l.id:l.cog_href,datetime:l[s]})))}o.sort((i,s)=>new Date(i.datetime).getTime()-new Date(s.datetime).getTime());const c=50;if(o.length<=c)return o;const u=o.length,d=[];for(let i=0;i<c;i++){const s=Math.floor(i*(u-1)/(c-1));d.push(o[s])}return d}const ge=ye([ce,pe]);function ye(e){return async n=>{for(const a of e){const t=await a(n);if(O.debug("Custom endpoint data:",t,"for callback:",a.name,"inputs:",n),!(!t||!t.length||t.some(o=>!o)))return t}return null}}async function ke({selectedStac:e,jsonformEl:n,jsonformSchema:a,chartSpec:t,isProcessed:r,processResults:o,loading:c,isPolling:u,enableCompare:d}){const i=d?!!D.value:!!N.value;let s=null;if(e.value?.["eodash:jsonform"]&&(s=await y.get(e.value["eodash:jsonform"]).then(f=>f.data)),!s&&i){a.value=null;return}ve({loading:c,isProcessed:r,chartSpec:t,jsonformSchema:a,isPolling:u,processResults:o}),await n.value?.editor.destroy(),s&&(d&&(s=R(s)),a.value=s)}async function Se({loading:e,selectedStac:n,jsonformEl:a,jsonformSchema:t,chartSpec:r,chartData:o,isPolling:c,processResults:u,mapElement:d,jobs:i}){if(!(!a.value||!t.value||!n.value)){O.debug("Processing..."),e.value=!0;try{const s=n.value?.links?.filter(v=>v.rel==="service"),f=C(t.value),l=a.value?.value;V(l,t.value);const h=l[f],g=n.value?.["eodash:vegadefinition"],p=n.value?.id??"";[r.value,o.value]=await X({links:s,jsonformValue:{...l??{}},jsonformSchema:t.value,enableCompare:d?.id==="compare",selectedStac:n.value,specUrl:g,isPolling:c,jobs:i,customEndpointsHandler:ge}),Object.keys(o.value??{}).length&&u.value.push(o.value),r.value?.data?.values?.length&&u.value.push(r.value?.data.values),r.value&&!("background"in r.value)&&(r.value.background="transparent"),await ae(s,l,d?.id==="compare");const m=await ne({isPolling:c,links:s,jsonformValue:{...l??{}},jsonformSchema:t.value,selectedStac:n.value,enableCompare:d?.id==="compare",layerId:p,origBbox:h,jobs:i,customLayersHandler:oe,projection:n.value["eodash:mapProjection"]?.name});if(m.length)for(const v of m)v.type==="WebGLTile"&&v.source?.type==="GeoTIFF"?u.value.push(...v.source.sources??[]):v.source&&"url"in v.source&&u.value.push(v.source.url);z(d,m),e.value=!1}catch(s){throw console.error("[eodash] Error while running process:",s),e.value=!1,s}}}function ve({loading:e,isProcessed:n,chartSpec:a,jsonformSchema:t,processResults:r,isPolling:o}){e.value=!1,n.value=!1,o.value=!1,a.value=null,r.value=[],t.value=null}const Le=e=>{const n=e.target?.spec;if(!n||!e.detail?.item?.datum||!e.detail?.item?.datum.datum)return;const a=Object.keys(n.encoding??{}).find(r=>n.encoding?.[r].type==="temporal");if(!a)return;const t=n.encoding?.[a].field;if(t)try{const r=e.detail.item;let o="";r.datum&&r.datum.datum?o=r.datum.datum[t]:o=r.datum[t];const c=new Date(o);H.value=c.toISOString()}catch(r){console.warn("[eodash] Error while setting datetime from eox-chart:",r)}},Te=()=>{b.value||(b.value=new URLSearchParams(window.location.search).get("indicator")??"");const e=U(),n=e.stac?.find(a=>_(a)===b.value);if(e.loadSelectedSTAC(n?.href),D.value)if(L.value){const a=e.stac?.find(t=>_(t)===L.value);e.loadSelectedCompareSTAC(a?.href).catch(t=>{console.error("[eodash] Error loading compare STAC:",t)})}else e.resetSelectedCompareSTAC()};export{Se as h,ke as i,Te as l,Le as o};
