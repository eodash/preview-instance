import{br as h,bc as b,b8 as _,ax as P,bs as A,bq as E,bt as G,bu as O,bv as H,aA as J,ay as T,bk as F,bw as V,aE as B,bx as q,by as M,aN as L,b7 as z}from"./index-sM6GxOqw.js";import{s as N,c as D,p as K,g as I,a as R,e as $}from"./async-DiB2iGoy.js";function j(t,n,r){if(!t)return;const e=t.filter(s=>s.rel==="service"&&s.type==="image/png"),a=[];for(const s of e)a.push({type:"Image",properties:{id:s.id+"_process",title:"Results "+s.id},source:{type:"ImageStatic",imageExtent:r,url:b.render(s.href,{...n??{}})}});return a}async function Q(t,n,r){if(!t)return;const e=[],a=t.filter(c=>c.rel==="service"&&c.type==="application/geo+json");if(a.length===0)return e;let s=null;for(const c of a){"eox:flatstyle"in(c??{})&&(s=await h.get(c["eox:flatstyle"]).then(l=>l.data));let o,i;if(s){const l=A(r??"",s);o=l.layerConfig,i=l.style}const u={type:"Vector",source:{type:"Vector",url:b.render(c.href,{...n??{}}),format:"GeoJSON"},properties:{id:c.id+"_process",title:"Results "+r,...o&&{...o}},...i&&{style:i}};e.push(u)}return e}async function W({links:t,jsonformValue:n,specUrl:r,customEndpointsHandler:e,jsonformSchema:a,selectedStac:s,isPolling:c}){if(!r||!t)return[null,null];const o=await h.get(r).then(d=>d.data);if(!o.data)return console.error("[eodash] Make sure the Vega spec definition has a data property"),[null,null];const i={},[u,l]=N(t,"service",void 0),f=e&&n&&await e({jsonformSchema:a,jsonformValue:n,links:l,selectedStac:s,isPolling:c});if(f&&f.length)return o.data.values=f,[o,i];const p=u.filter(d=>d.rel==="service");e:for(const d of p??[])switch(d.type){case void 0:continue;case"application/json":await X(o,{url:d.href,jsonformValue:n,link:d,flatstyleUrl:d["eox:flatstyle"]});break e;case"text/csv":await Y(o,{url:d.href,jsonformValue:n,flatstyleUrl:d["eox:flatstyle"]});break e}return[o,i]}async function X(t,{url:n,jsonformValue:r,link:e,flatstyleUrl:a}){if(t.data){if(e.method=="GET"){const s=b.parse(n).filter(function(o){return o[0]==="name"}).map(function(o){return o[1]});if(s.length>0&&r){const o=[];for(const i of s)if(Array.isArray(r[i]))for(const u of r[i]){const l=await S(n,{...r,[i]:u},a);o.push(await h.get(l).then(f=>f.data))}else{const u=await S(n,r,a);o.push(await h.get(u).then(l=>l.data))}return t.data.values=o.flat(),t}const c=await S(n,r,a);t.data.values=await h.get(c).then(o=>o.data)}else if(e.method=="POST"){if(!e.body)return console.error("[eodash] Inline data POST request requires a body template"),t;const s=await h.get(e.body,{responseType:"text"}).then(o=>o.data),c=JSON.parse(b.render(s,{...r??{}}));t.data.values=await h.post(n,c).then(o=>o.data)}return t}}async function Y(t,{url:n,jsonformValue:r,flatstyleUrl:e}){if(!t.data){console.error("[eodash] Make sure the Vega spec definition has a data property");return}const a=await S(n,r,e);return t.data.url=a,t}async function S(t,n,r){let e={};return r&&(e=await h.get(r).then(a=>a.data)),b.render(t,{...n??{},...e})}async function Z({links:t,jsonformValue:n,layerId:r,isPolling:e,projection:a,selectedStac:s,jsonformSchema:c,customEndpointsHandler:o}){if(!t)return;const[i,u]=N(t,"service","image/tiff"),l=o&&n&&await o({jsonformValue:n,links:u,selectedStac:s,isPolling:e,jsonformSchema:c});if(l&&l.length)return l;if(!i.length)return;let f=[],p="";for(const g of i??[])f.push(b.render(g.href,{...n??{}}));return i.map(g=>D(g,r,f,a,p))}async function ee(t,n){const r=t.find(a=>a.rel==="service"&&a.type=="application/json; profile=collection"&&a.endpoint==="STAC");if(!r)return;let e=b.render(r.href,{...n??{}});_.value&&(_.value=!1),await P().loadSelectedSTAC(e,!0)}async function te({links:t,jsonformValue:n,isPolling:r,selectedStac:e}){if(!r)return;const a=t.filter(s=>s.rel==="service"&&s.endpoint==="eoxhub_workspaces");for(const s of a){const c=await h.get(s.body,{responseType:"text"}).then(i=>i.data),o=JSON.parse(b.render(c,{...n??{}}));try{const i=await h.post(s.href,o,{headers:{"Content-Type":"application/json"}}),u=JSON.parse(localStorage.getItem(E.value)||"[]");u.push(i.headers.location),localStorage.setItem(E.value,JSON.stringify(u));const{processId:l,urls:f}=await K({processUrl:i.headers.location,isPolling:r}).then(p=>{const d=p?.urls;return d?.length?{processId:p?.id,urls:d}:{processId:"",urls:[]}}).catch(p=>(p instanceof Error?console.error("Polling failed:",p.message):console.error("Unknown error occurred during polling:",p),{processId:"",urls:[]}));return f.length?await D(s,e?.id??"",f,e?.["eodash:mapProjection"]?.name??void 0,l):void 0}catch(i){i instanceof Error?console.error("Error sending POST request:",i.message):console.error("Unknown error occurred:",i)}}}const ne=re([te]);function re(t){return async n=>await Promise.all(t.map(r=>r(n))).then(r=>r.filter(e=>e&&ae(e)))}function ae(t){return t&&t.source&&t.source.type==="GeoTIFF"&&t.source.sources?.length}var C={};async function oe({links:t,jsonformValue:n,jsonformSchema:r,selectedStac:e}){const a=t.find(d=>d.rel==="service"&&d.endpoint==="sentinelhub");if(!a)return;const s=await ce(e);if(!s){console.error("[eodash] evalscript link for sentinel hub not found in indicator",s);return}if(!a)return;const c=a.href,o=I(r),i=n[o],u=C.EODASH_SENTINELHUB_CLIENT_ID,l=C.EODASH_SENTINELHUB_CLIENT_SECRET,f=await se(u,l);if(!f){console.error("[eodash] Error while fetching bearer token from sentinel hub");return}const p=R(e.extent.temporal.interval[0],[n.start_date,n.end_date],n.distribution);return await Promise.all(p.map(([d,g])=>le({url:c,bearer:f,bbox:i,from:g,to:d,exampleLink:s}).catch(m=>console.error("[eodash] Error while fetching data from sentinel hub endpoint:",m)))).then(d=>d.flat().map(g=>g.outputs.data))}async function se(t,n){if(!t||!n){console.error("[eodash] Error (sentinelhub): client id or secret not found");return}const r=sessionStorage.getItem("sentinelhub_token"),e=sessionStorage.getItem("sentinelhub_token_time"),a=Date.now()-Number(e)<3600*1e3;if(r&&a)return sessionStorage.setItem("sentinelhub_token_time",Date.now().toString()),r;const s=await ie(t,n);if(s)return sessionStorage.setItem("sentinelhub_token_time",Date.now().toString()),sessionStorage.setItem("sentinelhub_token",s),s}async function ie(t,n){const r="https://services.sentinel-hub.com/oauth/token",e={"Content-Type":"application/x-www-form-urlencoded"},a=new URLSearchParams({client_id:t,client_secret:n,response_type:"token",grant_type:"client_credentials"});return await h.post(r,a,{headers:e}).then(s=>s.data.access_token)}async function le({url:t,bearer:n,bbox:r,from:e,to:a,timeout:s=2e4,exampleLink:c}){if(!c){console.error("[eodash] Error (sentinelhub): example link not found in indicator");return}if(!r){console.error("[eodash] Error (sentinelhub): bbox not found");return}if(!e||!a||new Date(e)>new Date(a)){console.error("[eodash] Error (sentinelhub): time range is faulty or not found",e,a);return}const o=await h.get(c.href,{responseType:"text"}).then(l=>l.data);if(!o||o.error){console.error("[eodash] Error (sentinelhub): evalscript not found",o);return}const i={input:{bounds:{bbox:r},data:[{dataFilter:{},type:c.dataId}]},aggregation:{evalscript:o,timeRange:{from:e,to:a},aggregationInterval:{of:"P1D"},width:100,height:100},calculations:{default:{}}},u={headers:{Authorization:`Bearer ${n}`,"Content-Type":"application/json"},params:{credentials:"same-origin"},timeout:s};return await h.post(t,i,u).then(l=>{const f=l.data.data;return f.forEach(p=>{p.outputs.data.date=e}),f}).catch(l=>{if(l.response?.status===401){console.error("[eodash] Error (sentinelhub): bearer token expired, please try again"),sessionStorage.removeItem("sentinelhub_token"),sessionStorage.removeItem("sentinelhub_token_time");return}return console.error("[eodash] Error (sentinelhub): error while fetching data from sentinel hub",l.response?.data),[]})}async function ce(t){const n=t.links.find(r=>r.rel==="example"&&r.title==="evalscript");if(n)return n;for(const r of G(t,O.value)){const e=h.get(r).then(a=>a.data.links.find(s=>s.rel==="example"&&s.title==="evalscript"));if(e)return e}}async function ue({links:t,jsonformSchema:n,jsonformValue:r,selectedStac:e}){const a=t.find(u=>u.rel==="service"&&u.endpoint==="veda");if(!a)return;const s=a?.href,c=I(n),o=JSON.parse(r[c]),i=await de(e);return await Promise.all(i.map(({endpoint:u,datetime:l})=>h.post(s+`?url=${u}`,{type:"Feature",properties:{},geometry:o}).then(f=>{const p=f.data.properties.statistics;return p.date=l,p}).catch(f=>console.error("[eodash] Error while fetching data from veda endpoint:",f))))}async function de(t){const n=t.links.filter(o=>o.rel=="child"),r=[];n.length?r.push(...await Promise.all(n.map(o=>h.get(H(o.href,O.value)).then(i=>i.data)))):r.push(t);const e=[];for(const o of r){const i=J(o.links);let u=o.links.filter(l=>l.rel=="item");e.push(...u.map(l=>({endpoint:l.cog_href,datetime:l[i]})))}e.sort((o,i)=>new Date(o.datetime).getTime()-new Date(i.datetime).getTime());const a=50;if(e.length<=a)return e;const s=e.length,c=[];for(let o=0;o<a;o++){const i=Math.floor(o*(s-1)/(a-1));c.push(e[i])}return c}const fe=pe([oe,ue]);function pe(t){return async n=>{for(const r of t){const e=await r(n);if(T.debug("Custom endpoint data:",e,"for callback:",r.name,"inputs:",n),!(!e||!e.length||e.some(s=>!s)))return e}return null}}async function me({selectedStac:t,jsonformEl:n,jsonformSchema:r,chartSpec:e,isProcessed:a,processResults:s,loading:c,isPolling:o}){let i=null;if(t.value["eodash:jsonform"]&&(i=await h.get(t.value["eodash:jsonform"]).then(u=>u.data)),!i&&F.value){r.value=null;return}he({loading:c,isProcessed:a,chartSpec:e,jsonformSchema:r,isPolling:o,processResults:s}),await n.value?.editor.destroy(),i&&(r.value=i)}async function be({loading:t,selectedStac:n,jsonformEl:r,jsonformSchema:e,chartSpec:a,chartData:s,isPolling:c,processResults:o}){if(!(!r.value||!e.value||!n.value)){T.debug("Processing..."),t.value=!0;try{const i=n.value?.links?.filter(v=>v.rel==="service"),u=I(e.value),l=r.value?.value;$(l,e.value);const f=l[u],p=n.value?.["eodash:vegadefinition"],d=n.value?.id??"";[a.value,s.value]=await W({links:i,jsonformValue:{...l??{}},jsonformSchema:e.value,selectedStac:n.value,specUrl:p,isPolling:c,customEndpointsHandler:fe}),Object.keys(s.value??{}).length&&o.value.push(s.value),a.value?.data?.values?.length&&o.value.push(a.value?.data.values),a.value&&!("background"in a.value)&&(a.value.background="transparent"),await ee(i,l);const g=await Z({links:i,jsonformValue:l,layerId:d,isPolling:c,projection:n.value?.["eodash:mapProjection"]?.name??null,jsonformSchema:e.value,selectedStac:n.value,customEndpointsHandler:ne});g?.forEach(v=>{v&&v.source?.sources.length&&o.value.push(...v.source?.sources?.map(x=>x.url)??[])});const m=await Q(i,l,d);m?.length&&o.value.push(...m.map(v=>v.source?.url));const w=j(i,l,f);if(w?.length&&o.value.push(...w.map(v=>v.source?.url)),T.debug("rendered layers after processing:",g,m,w),g?.length||m?.length||w?.length){const v=[...g??[],...m??[],...w??[]];let x=[...q()],k=x.find(y=>y.properties?.id.includes("AnalysisGroup"));if(!k)return;for(const y of v)k.layers.find(U=>U.properties?.id===y.properties?.id)?k.layers=M(k.layers,y.properties?.id??"",[y]):k.layers.unshift(y);if(L.value){const y=[...x];z("process:updated",L.value,y),L.value.layers=y}}t.value=!1}catch(i){throw console.error("[eodash] Error while running process:",i),t.value=!1,i}}}function he({loading:t,isProcessed:n,chartSpec:r,jsonformSchema:e,processResults:a,isPolling:s}){t.value=!1,n.value=!1,s.value=!1,r.value=null,a.value=[],e.value=null}const we=t=>{const n=t.target?.spec;if(!n)return;const r=Object.keys(n.encoding??{}).find(a=>n.encoding?.[a].type==="temporal");if(!r)return;const e=n.encoding?.[r].field;if(e)try{const a=t.detail.item,s=new Date(a.datum.datum[e]);B.value=s.toISOString()}catch(a){console.warn("[eodash] Error while setting datetime from eox-chart:",a)}},ke=()=>{E.value||(E.value=new URLSearchParams(window.location.search).get("indicator")??"");const t=P(),n=t.stac?.find(r=>V(r)===E.value);t.loadSelectedSTAC(n?.href)};export{be as h,me as i,ke as l,we as o};
