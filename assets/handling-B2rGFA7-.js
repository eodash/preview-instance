import{e as g,g as T,i as b,v as _,w as A,l as O,x as D,y as N,o as J}from"./templates-BHc6gmku.js";import{s as S,c as H,p as G,e as q,u as P,b as B,f as I,h as F,i as R,j as V,k as W,m as z}from"./async-DMhfeZjR.js";import{aT as w,Y as C,n as U,L as K,aU as M,aV as L,aW as Q,aX as Y,aY as $,P as X,aZ as E}from"./main-CGPd8rR8.js";async function Z({links:e,jsonformValue:n,specUrl:r,customEndpointsHandler:t,jsonformSchema:a,selectedStac:o,isPolling:l,jobs:c,enableCompare:u=!1}){if(!r||!e)return[null,null];const i=await g.get(r).then(p=>p.data),s={},[f,d]=S(e,"service",void 0),h=t&&n&&await t({jsonformSchema:a,jsonformValue:n,links:d,selectedStac:o,isPolling:l,jobs:c,enableCompare:u});if(h&&h.length)return i.data.values=h,[i,s];const y=f.filter(p=>p.rel==="service");try{e:for(const p of y??[])switch(p.type){case void 0:continue;case"application/json":await j(i,{url:p.href,jsonformValue:n,link:p,flatstyleUrl:p["eox:flatstyle"],jsonformSchema:a});break e;case"text/csv":await ee(i,{url:p.href,jsonformValue:n,flatstyleUrl:p["eox:flatstyle"]});break e;default:break}}catch(p){console.error("[eodash] Error while injecting Vega data",p)}return[i,s]}async function j(e,{url:n,jsonformValue:r,link:t,flatstyleUrl:a,jsonformSchema:o}){if(e.data){if(t.method=="GET"){const l=o?.options?.multiQuery,c=Object.keys(r??{}).filter(i=>Array.isArray(l)?l.includes(i):l===i);if(c.length>0&&r){const i=[];for(const s of c)if(Array.isArray(r[s]))for(const f of r[s]){const d=await k(n,{...r,[s]:f},a);i.push(await g.get(d).then(h=>h.data))}else{const f=await k(n,r,a);i.push(await g.get(f).then(d=>d.data))}return e.data.values=i.flat(),e}const u=await k(n,r,a);e.data.values=await g.get(u).then(i=>i.data)}else if(t.method=="POST"){if(!t.body)return console.error("[eodash] Inline data POST request requires a body template"),e;const l=await g.get(t.body,{responseType:"text"}).then(u=>u.data),c=JSON.parse(w.render(l,{...r??{}}));e.data.values=await g.post(n,c).then(u=>u.data)}return e}}async function ee(e,{url:n,jsonformValue:r,flatstyleUrl:t}){if(!e.data)return;const a=await k(n,r,t);return e.data.url=a,e}async function k(e,n,r){let t={};return r&&(t=await g.get(r).then(a=>a.data)),w.render(e,{...n??{},...t})}async function te({links:e,jsonformValue:n,layerId:r,projection:t}){if(!e)return;const[a,o]=S(e,"service","image/tiff");if(!a.length)return;let l=[],c="";for(const i of a??[])l.push(w.render(i.href,{...n??{}}));return await Promise.all(a.map(i=>H(i,r,l,t,c))).then(i=>i.filter(s=>!!s))}function re(e,n,r){if(!e)return;const t=e.filter(o=>o.rel==="service"&&o.type==="image/png"),a=[];for(const o of t)a.push({type:"Image",properties:{id:o.id+"_process",title:"Results "+o.id},source:{type:"ImageStatic",imageExtent:r,url:w.render(o.href,{...n??{}})}});return a}async function ne(e,n,r){if(!e)return;const t=[],a=e.filter(l=>l.rel==="service"&&l.type==="application/geo+json");if(!a.length)return t;let o=null;for(const l of a){"eox:flatstyle"in(l??{})&&(o=await g.get(l["eox:flatstyle"]).then(s=>s.data));let c,u;if(o){const s=K(r??"",o);c=s.layerConfig,u=s.style}const i={type:"Vector",source:{type:"Vector",url:w.render(l.href,{...n??{}}),format:"GeoJSON"},properties:{id:l.id+"_process",title:"Results "+r,...c&&{...c}},...u&&{style:u}};t.push(i)}return t}async function ae({links:e,jsonformValue:n,layerId:r,projection:t,origBbox:a,isPolling:o,selectedStac:l,jsonformSchema:c,jobs:u,customLayersHandler:i,enableCompare:s=!1}){if(!e)return[];const f=[],[d,h]=S(e,"service",void 0);if(i&&n&&l&&c&&h.length>0){const v=await i({jsonformValue:n,links:h,selectedStac:l,isPolling:o,jsonformSchema:c,jobs:u,enableCompare:s});v.length&&f.push(...v)}const y=await ne(d,n,r),p=re(d,n,a),m=await te({links:d,jsonformValue:n,layerId:r,projection:t});return f.push(...y??[],...p??[],...m??[]),f}async function oe(e,n,r=!1){const t=e.find(c=>c.rel==="service"&&c.type=="application/json; profile=collection"&&c.endpoint==="STAC");if(!t)return;let a=w.render(t.href,{...n??{}});C.value&&(C.value=!1);const o=U();await(r?o.loadSelectedCompareSTAC:o.loadSelectedSTAC)(a,!0)}async function se({links:e,jsonformValue:n,isPolling:r,selectedStac:t,jobs:a,enableCompare:o=!1}){if(!r)return;const l=e.filter(u=>u.rel==="service"&&u.endpoint==="eoxhub_workspaces"),c=[];for(const u of l){const i=await g.get(u.body,{responseType:"text"}).then(d=>d.data),s=JSON.parse(w.render(i,{...n??{}})),f=o?T:b;try{const d=await g.post(u.href,s,{headers:{"Content-Type":"application/json"}}),h=JSON.parse(localStorage.getItem(f.value)||"[]");h.push(d.headers.location),localStorage.setItem(f.value,JSON.stringify(h));const y=await G({jobs:a,processUrl:d.headers.location,isPolling:r,enableCompare:o}).then(p=>q(p)).catch(p=>(p instanceof Error?console.error("Polling failed:",p.message):console.error("Unknown error occurred during polling:",p),[]));await P(a,f.value),c.push(...await B(y,u,t))}catch(d){await P(a,f.value),d instanceof Error?console.error("Error sending POST request:",d.message):console.error("Unknown error occurred:",d)}}return c}const ie=le([se]);function le(e){return async n=>await Promise.all(e.map(r=>r(n))).then(r=>{const t=[];for(const a of r)t.push(...a?.filter(ce)??[]);return t})}function ce(e){return!!e&&!!e.type&&(!!e.source||!!e.layers)}var x={};async function ue({links:e,jsonformValue:n,jsonformSchema:r,selectedStac:t,enableCompare:a=!1}){const o=e.find(y=>y.rel==="service"&&y.endpoint==="sentinelhub");if(!o)return;const l=await he(t,a?_.value:A.value);if(!l){console.error("[eodash] evalscript link for sentinel hub not found in indicator",l);return}if(!o)return;const c=o.href,u=I(r),i=n[u],s=x.EODASH_SENTINELHUB_CLIENT_ID,f=x.EODASH_SENTINELHUB_CLIENT_SECRET,d=await de(s,f);if(!d){console.error("[eodash] Error while fetching bearer token from sentinel hub");return}const h=F(t.extent.temporal.interval[0],[n.start_date,n.end_date],n.distribution);return await Promise.all(h.map(([y,p])=>pe({url:c,bearer:d,bbox:i,from:p,to:y,exampleLink:l}).catch(m=>console.error("[eodash] Error while fetching data from sentinel hub endpoint:",m)))).then(y=>y.flat().map(p=>p.outputs.data))}async function de(e,n){if(!e||!n){console.error("[eodash] Error (sentinelhub): client id or secret not found");return}const r=sessionStorage.getItem("sentinelhub_token"),t=sessionStorage.getItem("sentinelhub_token_time"),a=Date.now()-Number(t)<3600*1e3;if(r&&a)return sessionStorage.setItem("sentinelhub_token_time",Date.now().toString()),r;const o=await fe(e,n);if(o)return sessionStorage.setItem("sentinelhub_token_time",Date.now().toString()),sessionStorage.setItem("sentinelhub_token",o),o}async function fe(e,n){const r="https://services.sentinel-hub.com/oauth/token",t={"Content-Type":"application/x-www-form-urlencoded"},a=new URLSearchParams({client_id:e,client_secret:n,response_type:"token",grant_type:"client_credentials"});return await g.post(r,a,{headers:t}).then(o=>o.data.access_token)}async function pe({url:e,bearer:n,bbox:r,from:t,to:a,timeout:o=2e4,exampleLink:l}){if(!l){console.error("[eodash] Error (sentinelhub): example link not found in indicator");return}if(!r){console.error("[eodash] Error (sentinelhub): bbox not found");return}if(!t||!a||new Date(t)>new Date(a)){console.error("[eodash] Error (sentinelhub): time range is faulty or not found",t,a);return}const c=await g.get(l.href,{responseType:"text"}).then(s=>s.data);if(!c||c.error){console.error("[eodash] Error (sentinelhub): evalscript not found",c);return}const u={input:{bounds:{bbox:r},data:[{dataFilter:{},type:l.dataId}]},aggregation:{evalscript:c,timeRange:{from:t,to:a},aggregationInterval:{of:"P1D"},width:100,height:100},calculations:{default:{}}},i={headers:{Authorization:`Bearer ${n}`,"Content-Type":"application/json"},params:{credentials:"same-origin"},timeout:o};return await g.post(e,u,i).then(s=>{const f=s.data.data;return f.forEach(d=>{d.outputs.data.date=t}),f}).catch(s=>{if(s.response?.status===401){console.error("[eodash] Error (sentinelhub): bearer token expired, please try again"),sessionStorage.removeItem("sentinelhub_token"),sessionStorage.removeItem("sentinelhub_token_time");return}return console.error("[eodash] Error (sentinelhub): error while fetching data from sentinel hub",s.response?.data),[]})}async function he(e,n){const r=e.links.find(t=>t.rel==="example"&&t.title==="evalscript");if(r)return r;for(const t of M(e,n)){const a=g.get(t).then(o=>o.data.links.find(l=>l.rel==="example"&&l.title==="evalscript"));if(a)return a}}async function ye({links:e,jsonformSchema:n,jsonformValue:r,selectedStac:t,enableCompare:a=!1}){const o=e.find(s=>s.rel==="service"&&(s.endpoint==="veda"||s.endpoint==="veda_stac"));if(!o)return;const l=o?.href,c=I(n),u=JSON.parse(r[c]),i=await ge(t,a?_.value:A.value,o);return await Promise.all(i.map(({endpoint:s,datetime:f})=>{const d=new URL(l),h=o.endpoint==="veda_stac"?"ids":"url";return d.searchParams.set(h,s),g.post(d.toString(),{type:"Feature",properties:{},geometry:u}).then(y=>{const p=y.data.properties.statistics;return p.date=f,p}).catch(y=>console.error("[eodash] Error while fetching data from veda endpoint:",y))}))}async function ge(e,n,r){const t=e.links.filter(i=>i.rel=="child"),a=[];t.length?a.push(...await Promise.all(t.map(i=>g.get(L(i.href,n)).then(s=>s.data).then(async s=>{const f=Object.values(s.assets??{}).find(d=>d.type==="application/vnd.apache.parquet"&&d.roles?.includes("collection-mirror"));if(f){const d=L(f.href,L(i.href,n));await Q(d).then(h=>{s.links.push(...Y(h))})}return s})))):a.push(e);const o=[];for(const i of a){const s=$(i.links),f=i.links.filter(d=>d.rel=="item");o.push(...f.map(d=>({endpoint:r.endpoint==="veda_stac"?d.id:d.cog_href,datetime:d[s]})))}o.sort((i,s)=>new Date(i.datetime).getTime()-new Date(s.datetime).getTime());const l=50;if(o.length<=l)return o;const c=o.length,u=[];for(let i=0;i<l;i++){const s=Math.floor(i*(c-1)/(l-1));u.push(o[s])}return u}const ve=me([ue,ye]);function me(e){return async n=>{for(const r of e){const t=await r(n);if(O.debug("Custom endpoint data:",t,"for callback:",r.name,"inputs:",n),!(!t||!t.length||t.some(o=>!o)))return t}return null}}async function Se({selectedStac:e,jsonformEl:n,jsonformSchema:r,chartSpec:t,isProcessed:a,processResults:o,loading:l,isPolling:c,enableCompare:u}){const i=u?!!D.value:!!N.value;let s=null;if(e.value?.["eodash:jsonform"]&&(s=await g.get(e.value["eodash:jsonform"]).then(f=>f.data)),!s&&i){r.value=null;return}be({loading:l,isProcessed:a,chartSpec:t,jsonformSchema:r,isPolling:c,processResults:o}),await n.value?.editor.destroy(),s&&(s.properties?.feature?.options?.drawtools?.layerId&&await we({jsonformSchema:r,newLayers:await X()}),u&&(s=R(s)),r.value=s)}async function we({jsonformSchema:e,newLayers:n}){const r=e.value;if(!r)return;const t=V(r);if(t&&n&&r?.properties[t]?.options?.drawtools?.layerId){let a=n;n.layers&&Array.isArray(n.layers)&&(a=n.layers);const o=r.properties[t].options.drawtools.layerId.split(";:;")[0];let l=null;const c=u=>{if(u){for(const i of u)if(i.layers)c(i);else if(i.properties?.id?.startsWith(o)){l=i.properties.id;break}}};if(c(a),l)r.properties.feature.options.drawtools.layerId=l,e.value=null,await new Promise(u=>setTimeout(u,0)),e.value=r;else throw new Error(`Could not find matching layer for processing form with id: ${o}`)}}async function Ie({loading:e,selectedStac:n,jsonformEl:r,jsonformSchema:t,chartSpec:a,chartData:o,isPolling:l,processResults:c,mapElement:u,jobs:i}){if(!(!r.value||!t.value||!n.value)){O.debug("Processing..."),e.value=!0;try{const s=n.value?.links?.filter(v=>v.rel==="service"),f=I(t.value),d=r.value?.value;W(d,t.value);const h=d[f],y=n.value?.["eodash:vegadefinition"],p=n.value?.id??"";[a.value,o.value]=await Z({links:s,jsonformValue:{...d??{}},jsonformSchema:t.value,enableCompare:u?.id==="compare",selectedStac:n.value,specUrl:y,isPolling:l,jobs:i,customEndpointsHandler:ve}),Object.keys(o.value??{}).length&&c.value.push(o.value),a.value?.data?.values?.length&&c.value.push(a.value?.data.values),a.value&&!("background"in a.value)&&(a.value.background="transparent"),await oe(s,d,u?.id==="compare");const m=await ae({isPolling:l,links:s,jsonformValue:{...d??{}},jsonformSchema:t.value,selectedStac:n.value,enableCompare:u?.id==="compare",layerId:p,origBbox:h,jobs:i,customLayersHandler:ie,projection:n.value["eodash:mapProjection"]?.name});if(m.length)for(const v of m)v.type==="WebGLTile"&&v.source?.type==="GeoTIFF"?c.value.push(...v.source.sources??[]):v.source&&"url"in v.source&&c.value.push(v.source.url);z(u,m),e.value=!1}catch(s){throw console.error("[eodash] Error while running process:",s),e.value=!1,s}}}function be({loading:e,isProcessed:n,chartSpec:r,jsonformSchema:t,processResults:a,isPolling:o}){e.value=!1,n.value=!1,o.value=!1,r.value=null,a.value=[],t.value=null}const Pe=e=>{const n=e.target?.spec;if(!n||!e.detail?.item?.datum||!e.detail?.item?.datum.datum)return;const r=Object.keys(n.encoding??{}).find(a=>n.encoding?.[a].type==="temporal");if(!r)return;const t=n.encoding?.[r].field;if(t)try{const a=e.detail.item;let o="";a.datum&&a.datum.datum?o=a.datum.datum[t]:o=a.datum[t];const l=new Date(o);J.value=l.toISOString()}catch(a){console.warn("[eodash] Error while setting datetime from eox-chart:",a)}},Ce=()=>{b.value||(b.value=new URLSearchParams(window.location.search).get("indicator")??"");const e=U(),n=e.stac?.find(r=>E(r)===b.value);if(e.loadSelectedSTAC(n?.href),D.value)if(T.value){const r=e.stac?.find(t=>E(t)===T.value);e.loadSelectedCompareSTAC(r?.href).catch(t=>{console.error("[eodash] Error loading compare STAC:",t)})}else e.resetSelectedCompareSTAC()};export{Ie as h,Se as i,Ce as l,Pe as o,we as u};
