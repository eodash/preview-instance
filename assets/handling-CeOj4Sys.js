import{e as g,g as L,i as b,v as I,w as A,l as O,x as D,y as U,o as H}from"./templates-BHc6gmku.js";import{s as T,c as J,p as G,e as q,u as E,b as B,f as C,h as F,i as R,j as V,k as z}from"./async-Dp5agErW.js";import{aT as w,Y as x,n as N,L as K,aU as M,aV as S,aW as Q,aX as W,aY as Y,aZ as P}from"./main-BRkRoPlc.js";async function $({links:e,jsonformValue:a,specUrl:r,customEndpointsHandler:t,jsonformSchema:n,selectedStac:o,isPolling:c,jobs:u,enableCompare:l=!1}){if(!r||!e)return[null,null];const s=await g.get(r).then(p=>p.data),i={},[d,f]=T(e,"service",void 0),h=t&&a&&await t({jsonformSchema:n,jsonformValue:a,links:f,selectedStac:o,isPolling:c,jobs:u,enableCompare:l});if(h&&h.length)return s.data.values=h,[s,i];const y=d.filter(p=>p.rel==="service");try{e:for(const p of y??[])switch(p.type){case void 0:continue;case"application/json":await X(s,{url:p.href,jsonformValue:a,link:p,flatstyleUrl:p["eox:flatstyle"],jsonformSchema:n});break e;case"text/csv":await Z(s,{url:p.href,jsonformValue:a,flatstyleUrl:p["eox:flatstyle"]});break e;default:break}}catch(p){console.error("[eodash] Error while injecting Vega data",p)}return[s,i]}async function X(e,{url:a,jsonformValue:r,link:t,flatstyleUrl:n,jsonformSchema:o}){if(e.data){if(t.method=="GET"){const c=o?.options?.multiQuery,u=Object.keys(r??{}).filter(s=>Array.isArray(c)?c.includes(s):c===s);if(u.length>0&&r){const s=[];for(const i of u)if(Array.isArray(r[i]))for(const d of r[i]){const f=await k(a,{...r,[i]:d},n);s.push(await g.get(f).then(h=>h.data))}else{const d=await k(a,r,n);s.push(await g.get(d).then(f=>f.data))}return e.data.values=s.flat(),e}const l=await k(a,r,n);e.data.values=await g.get(l).then(s=>s.data)}else if(t.method=="POST"){if(!t.body)return console.error("[eodash] Inline data POST request requires a body template"),e;const c=await g.get(t.body,{responseType:"text"}).then(l=>l.data),u=JSON.parse(w.render(c,{...r??{}}));e.data.values=await g.post(a,u).then(l=>l.data)}return e}}async function Z(e,{url:a,jsonformValue:r,flatstyleUrl:t}){if(!e.data)return;const n=await k(a,r,t);return e.data.url=n,e}async function k(e,a,r){let t={};return r&&(t=await g.get(r).then(n=>n.data)),w.render(e,{...a??{},...t})}async function j({links:e,jsonformValue:a,layerId:r,projection:t}){if(!e)return;const[n,o]=T(e,"service","image/tiff");if(!n.length)return;let c=[],u="";for(const s of n??[])c.push(w.render(s.href,{...a??{}}));return await Promise.all(n.map(s=>J(s,r,c,t,u))).then(s=>s.filter(i=>!!i))}function ee(e,a,r){if(!e)return;const t=e.filter(o=>o.rel==="service"&&o.type==="image/png"),n=[];for(const o of t)n.push({type:"Image",properties:{id:o.id+"_process",title:"Results "+o.id},source:{type:"ImageStatic",imageExtent:r,url:w.render(o.href,{...a??{}})}});return n}async function te(e,a,r){if(!e)return;const t=[],n=e.filter(c=>c.rel==="service"&&c.type==="application/geo+json");if(!n.length)return t;let o=null;for(const c of n){"eox:flatstyle"in(c??{})&&(o=await g.get(c["eox:flatstyle"]).then(i=>i.data));let u,l;if(o){const i=K(r??"",o);u=i.layerConfig,l=i.style}const s={type:"Vector",source:{type:"Vector",url:w.render(c.href,{...a??{}}),format:"GeoJSON"},properties:{id:c.id+"_process",title:"Results "+r,...u&&{...u}},...l&&{style:l}};t.push(s)}return t}async function ne({links:e,jsonformValue:a,layerId:r,projection:t,origBbox:n,isPolling:o,selectedStac:c,jsonformSchema:u,jobs:l,customLayersHandler:s,enableCompare:i=!1}){if(!e)return[];const d=[],[f,h]=T(e,"service",void 0);if(s&&a&&c&&u&&h.length>0){const v=await s({jsonformValue:a,links:h,selectedStac:c,isPolling:o,jsonformSchema:u,jobs:l,enableCompare:i});v.length&&d.push(...v)}const y=await te(f,a,r),p=ee(f,a,n),m=await j({links:f,jsonformValue:a,layerId:r,projection:t});return d.push(...y??[],...p??[],...m??[]),d}async function ae(e,a,r=!1){const t=e.find(u=>u.rel==="service"&&u.type=="application/json; profile=collection"&&u.endpoint==="STAC");if(!t)return;let n=w.render(t.href,{...a??{}});x.value&&(x.value=!1);const o=N();await(r?o.loadSelectedCompareSTAC:o.loadSelectedSTAC)(n,!0)}async function re({links:e,jsonformValue:a,isPolling:r,selectedStac:t,jobs:n,enableCompare:o=!1}){if(!r)return;const c=e.filter(l=>l.rel==="service"&&l.endpoint==="eoxhub_workspaces"),u=[];for(const l of c){const s=await g.get(l.body,{responseType:"text"}).then(f=>f.data),i=JSON.parse(w.render(s,{...a??{}})),d=o?L:b;try{const f=await g.post(l.href,i,{headers:{"Content-Type":"application/json"}}),h=JSON.parse(localStorage.getItem(d.value)||"[]");h.push(f.headers.location),localStorage.setItem(d.value,JSON.stringify(h));const y=await G({jobs:n,processUrl:f.headers.location,isPolling:r,enableCompare:o}).then(p=>q(p)).catch(p=>(p instanceof Error?console.error("Polling failed:",p.message):console.error("Unknown error occurred during polling:",p),[]));await E(n,d.value),u.push(...await B(y,l,t))}catch(f){await E(n,d.value),f instanceof Error?console.error("Error sending POST request:",f.message):console.error("Unknown error occurred:",f)}}return u}const oe=se([re]);function se(e){return async a=>await Promise.all(e.map(r=>r(a))).then(r=>{const t=[];for(const n of r)t.push(...n?.filter(ie)??[]);return t})}function ie(e){return!!e&&!!e.type&&(!!e.source||!!e.layers)}var _={};async function le({links:e,jsonformValue:a,jsonformSchema:r,selectedStac:t,enableCompare:n=!1}){const o=e.find(y=>y.rel==="service"&&y.endpoint==="sentinelhub");if(!o)return;const c=await fe(t,n?I.value:A.value);if(!c){console.error("[eodash] evalscript link for sentinel hub not found in indicator",c);return}if(!o)return;const u=o.href,l=C(r),s=a[l],i=_.EODASH_SENTINELHUB_CLIENT_ID,d=_.EODASH_SENTINELHUB_CLIENT_SECRET,f=await ce(i,d);if(!f){console.error("[eodash] Error while fetching bearer token from sentinel hub");return}const h=F(t.extent.temporal.interval[0],[a.start_date,a.end_date],a.distribution);return await Promise.all(h.map(([y,p])=>de({url:u,bearer:f,bbox:s,from:p,to:y,exampleLink:c}).catch(m=>console.error("[eodash] Error while fetching data from sentinel hub endpoint:",m)))).then(y=>y.flat().map(p=>p.outputs.data))}async function ce(e,a){if(!e||!a){console.error("[eodash] Error (sentinelhub): client id or secret not found");return}const r=sessionStorage.getItem("sentinelhub_token"),t=sessionStorage.getItem("sentinelhub_token_time"),n=Date.now()-Number(t)<3600*1e3;if(r&&n)return sessionStorage.setItem("sentinelhub_token_time",Date.now().toString()),r;const o=await ue(e,a);if(o)return sessionStorage.setItem("sentinelhub_token_time",Date.now().toString()),sessionStorage.setItem("sentinelhub_token",o),o}async function ue(e,a){const r="https://services.sentinel-hub.com/oauth/token",t={"Content-Type":"application/x-www-form-urlencoded"},n=new URLSearchParams({client_id:e,client_secret:a,response_type:"token",grant_type:"client_credentials"});return await g.post(r,n,{headers:t}).then(o=>o.data.access_token)}async function de({url:e,bearer:a,bbox:r,from:t,to:n,timeout:o=2e4,exampleLink:c}){if(!c){console.error("[eodash] Error (sentinelhub): example link not found in indicator");return}if(!r){console.error("[eodash] Error (sentinelhub): bbox not found");return}if(!t||!n||new Date(t)>new Date(n)){console.error("[eodash] Error (sentinelhub): time range is faulty or not found",t,n);return}const u=await g.get(c.href,{responseType:"text"}).then(i=>i.data);if(!u||u.error){console.error("[eodash] Error (sentinelhub): evalscript not found",u);return}const l={input:{bounds:{bbox:r},data:[{dataFilter:{},type:c.dataId}]},aggregation:{evalscript:u,timeRange:{from:t,to:n},aggregationInterval:{of:"P1D"},width:100,height:100},calculations:{default:{}}},s={headers:{Authorization:`Bearer ${a}`,"Content-Type":"application/json"},params:{credentials:"same-origin"},timeout:o};return await g.post(e,l,s).then(i=>{const d=i.data.data;return d.forEach(f=>{f.outputs.data.date=t}),d}).catch(i=>{if(i.response?.status===401){console.error("[eodash] Error (sentinelhub): bearer token expired, please try again"),sessionStorage.removeItem("sentinelhub_token"),sessionStorage.removeItem("sentinelhub_token_time");return}return console.error("[eodash] Error (sentinelhub): error while fetching data from sentinel hub",i.response?.data),[]})}async function fe(e,a){const r=e.links.find(t=>t.rel==="example"&&t.title==="evalscript");if(r)return r;for(const t of M(e,a)){const n=g.get(t).then(o=>o.data.links.find(c=>c.rel==="example"&&c.title==="evalscript"));if(n)return n}}async function pe({links:e,jsonformSchema:a,jsonformValue:r,selectedStac:t,enableCompare:n=!1}){const o=e.find(i=>i.rel==="service"&&i.endpoint==="veda");if(!o)return;const c=o?.href,u=C(a),l=JSON.parse(r[u]),s=await he(t,n?I.value:A.value);return await Promise.all(s.map(({endpoint:i,datetime:d})=>g.post(c+`?url=${i}`,{type:"Feature",properties:{},geometry:l}).then(f=>{const h=f.data.properties.statistics;return h.date=d,h}).catch(f=>console.error("[eodash] Error while fetching data from veda endpoint:",f))))}async function he(e,a){const r=e.links.filter(l=>l.rel=="child"),t=[];r.length?t.push(...await Promise.all(r.map(l=>g.get(S(l.href,a)).then(s=>s.data).then(async s=>{const i=Object.values(s.assets??{}).find(d=>d.type==="application/vnd.apache.parquet"&&d.roles?.includes("collection-mirror"));if(i){const d=S(i.href,S(l.href,a));await Q(d).then(f=>{s.links.push(...W(f))})}return s})))):t.push(e);const n=[];for(const l of t){const s=Y(l.links),i=l.links.filter(d=>d.rel=="item");n.push(...i.map(d=>({endpoint:d.cog_href,datetime:d[s]})))}n.sort((l,s)=>new Date(l.datetime).getTime()-new Date(s.datetime).getTime());const o=50;if(n.length<=o)return n;const c=n.length,u=[];for(let l=0;l<o;l++){const s=Math.floor(l*(c-1)/(o-1));u.push(n[s])}return u}const ge=ye([le,pe]);function ye(e){return async a=>{for(const r of e){const t=await r(a);if(O.debug("Custom endpoint data:",t,"for callback:",r.name,"inputs:",a),!(!t||!t.length||t.some(o=>!o)))return t}return null}}async function ke({selectedStac:e,jsonformEl:a,jsonformSchema:r,chartSpec:t,isProcessed:n,processResults:o,loading:c,isPolling:u,enableCompare:l}){const s=l?!!D.value:!!U.value;let i=null;if(e.value?.["eodash:jsonform"]&&(i=await g.get(e.value["eodash:jsonform"]).then(d=>d.data)),!i&&s){r.value=null;return}ve({loading:c,isProcessed:n,chartSpec:t,jsonformSchema:r,isPolling:u,processResults:o}),await a.value?.editor.destroy(),i&&(l&&(i=R(i)),r.value=i)}async function Se({loading:e,selectedStac:a,jsonformEl:r,jsonformSchema:t,chartSpec:n,chartData:o,isPolling:c,processResults:u,mapElement:l,jobs:s}){if(!(!r.value||!t.value||!a.value)){O.debug("Processing..."),e.value=!0;try{const i=a.value?.links?.filter(v=>v.rel==="service"),d=C(t.value),f=r.value?.value;V(f,t.value);const h=f[d],y=a.value?.["eodash:vegadefinition"],p=a.value?.id??"";[n.value,o.value]=await $({links:i,jsonformValue:{...f??{}},jsonformSchema:t.value,enableCompare:l?.id==="compare",selectedStac:a.value,specUrl:y,isPolling:c,jobs:s,customEndpointsHandler:ge}),Object.keys(o.value??{}).length&&u.value.push(o.value),n.value?.data?.values?.length&&u.value.push(n.value?.data.values),n.value&&!("background"in n.value)&&(n.value.background="transparent"),await ae(i,f,l?.id==="compare");const m=await ne({isPolling:c,links:i,jsonformValue:{...f??{}},jsonformSchema:t.value,selectedStac:a.value,enableCompare:l?.id==="compare",layerId:p,origBbox:h,jobs:s,customLayersHandler:oe,projection:a.value["eodash:mapProjection"]?.name});if(m.length)for(const v of m)v.type==="WebGLTile"&&v.source?.type==="GeoTIFF"?u.value.push(...v.source.sources??[]):v.source&&"url"in v.source&&u.value.push(v.source.url);z(l,m),e.value=!1}catch(i){throw console.error("[eodash] Error while running process:",i),e.value=!1,i}}}function ve({loading:e,isProcessed:a,chartSpec:r,jsonformSchema:t,processResults:n,isPolling:o}){e.value=!1,a.value=!1,o.value=!1,r.value=null,n.value=[],t.value=null}const Le=e=>{const a=e.target?.spec;if(!a||!e.detail?.item?.datum||!e.detail?.item?.datum.datum)return;const r=Object.keys(a.encoding??{}).find(n=>a.encoding?.[n].type==="temporal");if(!r)return;const t=a.encoding?.[r].field;if(t)try{const n=e.detail.item;let o="";n.datum&&n.datum.datum?o=n.datum.datum[t]:o=n.datum[t];const c=new Date(o);H.value=c.toISOString()}catch(n){console.warn("[eodash] Error while setting datetime from eox-chart:",n)}},Te=()=>{b.value||(b.value=new URLSearchParams(window.location.search).get("indicator")??"");const e=N(),a=e.stac?.find(r=>P(r)===b.value);if(e.loadSelectedSTAC(a?.href),D.value)if(L.value){const r=e.stac?.find(t=>P(t)===L.value);e.loadSelectedCompareSTAC(r?.href).catch(t=>{console.error("[eodash] Error loading compare STAC:",t)})}else e.resetSelectedCompareSTAC()};export{Se as h,ke as i,Te as l,Le as o};
