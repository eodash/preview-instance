import{e as v,g as L,i as b,v as _,w as A,l as O,x as D,y as J,o as H}from"./templates-CeJFuBW4.js";import{s as S,c as G,p as q,e as B,u as P,b as F,f as I,h as R,i as V,j as W,k as z,m as K}from"./async-CsujsYut.js";import{aT as w,Y as C,n as U,L as M,aU as Q,aV as T,aW as Y,aX as $,aY as X,P as Z,aZ as E}from"./main-C09NvQge.js";async function j({links:e,jsonformValue:a,specUrl:n,customEndpointsHandler:t,jsonformSchema:r,selectedStac:o,isPolling:l,jobs:c,enableCompare:u=!1}){if(!n||!e)return[null,null];const s=await v.get(n).then(p=>p.data),i={},[f,d]=S(e,"service",void 0),h=t&&a&&await t({jsonformSchema:r,jsonformValue:a,links:d,selectedStac:o,isPolling:l,jobs:c,enableCompare:u});if(h&&h.length)return s.data.values=h,[s,i];const y=f.filter(p=>p.rel==="service"),g=y.filter(p=>p.type==="application/json");if(g.length>=2){for(const p of g??[])switch(p.type){case void 0:continue;case"application/json":i[p.id]=await v.get(w.render(p.href,{...a??{}})).then(N=>N.data),s.data&&(s.data.values={...s.data&&"values"in s.data&&typeof s.data.values=="object"?s.data.values:{},[p.id]:i[p.id]});break}return[s,i]}try{e:for(const p of y??[])switch(p.type){case void 0:continue;case"application/json":await ee(s,{url:p.href,jsonformValue:a,link:p,flatstyleUrl:p["eox:flatstyle"],jsonformSchema:r});break e;case"text/csv":await te(s,{url:p.href,jsonformValue:a,flatstyleUrl:p["eox:flatstyle"]});break e;default:break}}catch(p){console.error("[eodash] Error while injecting Vega data",p)}return[s,i]}async function ee(e,{url:a,jsonformValue:n,link:t,flatstyleUrl:r,jsonformSchema:o}){if(e.data){if(t.method=="GET"){const l=o?.options?.multiQuery,c=Object.keys(n??{}).filter(s=>Array.isArray(l)?l.includes(s):l===s);if(c.length>0&&n){const s=[];for(const i of c)if(Array.isArray(n[i]))for(const f of n[i]){const d=await k(a,{...n,[i]:f},r);s.push(await v.get(d).then(h=>h.data))}else{const f=await k(a,n,r);s.push(await v.get(f).then(d=>d.data))}return e.data.values=s.flat(),e}const u=await k(a,n,r);e.data.values=await v.get(u).then(s=>s.data)}else if(t.method=="POST"){if(!t.body)return console.error("[eodash] Inline data POST request requires a body template"),e;const l=await v.get(t.body,{responseType:"text"}).then(u=>u.data),c=JSON.parse(w.render(l,{...n??{}}));e.data.values=await v.post(a,c).then(u=>u.data)}return e}}async function te(e,{url:a,jsonformValue:n,flatstyleUrl:t}){if(!e.data)return;const r=await k(a,n,t);return e.data.url=r,e}async function k(e,a,n){let t={};return n&&(t=await v.get(n).then(r=>r.data)),w.render(e,{...a??{},...t})}async function ae({links:e,jsonformValue:a,layerId:n,projection:t}){if(!e)return;const[r,o]=S(e,"service","image/tiff");if(!r.length)return;let l=[],c="";for(const s of r??[])l.push(w.render(s.href,{...a??{}}));return await Promise.all(r.map(s=>G(s,n,l,t,c))).then(s=>s.filter(i=>!!i))}function ne(e,a,n){if(!e)return;const t=e.filter(o=>o.rel==="service"&&o.type==="image/png"),r=[];for(const o of t)r.push({type:"Image",properties:{id:o.id+"_process",title:"Results "+o.id},source:{type:"ImageStatic",imageExtent:n,url:w.render(o.href,{...a??{}})}});return r}async function re(e,a,n){if(!e)return;const t=[],r=e.filter(l=>l.rel==="service"&&l.type==="application/geo+json");if(!r.length)return t;let o=null;for(const l of r){"eox:flatstyle"in(l??{})&&(o=await v.get(l["eox:flatstyle"]).then(i=>i.data));let c,u;if(o){const i=M(n??"",o);c=i.layerConfig,u=i.style}const s={type:"Vector",source:{type:"Vector",url:w.render(l.href,{...a??{}}),format:"GeoJSON"},properties:{id:l.id+"_process",title:"Results "+n,...c&&{...c}},...u&&{style:u}};t.push(s)}return t}async function oe({links:e,jsonformValue:a,layerId:n,projection:t,origBbox:r,isPolling:o,selectedStac:l,jsonformSchema:c,jobs:u,customLayersHandler:s,enableCompare:i=!1}){if(!e)return[];const f=[],[d,h]=S(e,"service",void 0);if(s&&a&&l&&c&&h.length>0){const m=await s({jsonformValue:a,links:h,selectedStac:l,isPolling:o,jsonformSchema:c,jobs:u,enableCompare:i});m.length&&f.push(...m)}const y=await re(d,a,n),g=ne(d,a,r),p=await ae({links:d,jsonformValue:a,layerId:n,projection:t});return f.push(...y??[],...g??[],...p??[]),f}async function se(e,a,n=!1){const t=e.find(c=>c.rel==="service"&&c.type=="application/json; profile=collection"&&c.endpoint==="STAC");if(!t)return;let r=w.render(t.href,{...a??{}});C.value&&(C.value=!1);const o=U();await(n?o.loadSelectedCompareSTAC:o.loadSelectedSTAC)(r,!0)}async function ie({links:e,jsonformValue:a,isPolling:n,selectedStac:t,jobs:r,enableCompare:o=!1}){if(!n)return;const l=e.filter(u=>u.rel==="service"&&u.endpoint==="eoxhub_workspaces"),c=[];for(const u of l){const s=await v.get(u.body,{responseType:"text"}).then(d=>d.data),i=JSON.parse(w.render(s,{...a??{}})),f=o?L:b;try{const d=await v.post(u.href,i,{headers:{"Content-Type":"application/json"}}),h=JSON.parse(localStorage.getItem(f.value)||"[]");h.push(d.headers.location),localStorage.setItem(f.value,JSON.stringify(h));const y=await q({jobs:r,processUrl:d.headers.location,isPolling:n,enableCompare:o}).then(g=>B(g)).catch(g=>(g instanceof Error?console.error("Polling failed:",g.message):console.error("Unknown error occurred during polling:",g),[]));await P(r,f.value),c.push(...await F(y,u,t))}catch(d){await P(r,f.value),d instanceof Error?console.error("Error sending POST request:",d.message):console.error("Unknown error occurred:",d)}}return c}const le=ce([ie]);function ce(e){return async a=>await Promise.all(e.map(n=>n(a))).then(n=>{const t=[];for(const r of n)t.push(...r?.filter(ue)??[]);return t})}function ue(e){return!!e&&!!e.type&&(!!e.source||!!e.layers)}var x={};async function de({links:e,jsonformValue:a,jsonformSchema:n,selectedStac:t,enableCompare:r=!1}){const o=e.find(y=>y.rel==="service"&&y.endpoint==="sentinelhub");if(!o)return;const l=await ye(t,r?_.value:A.value);if(!l){console.error("[eodash] evalscript link for sentinel hub not found in indicator",l);return}if(!o)return;const c=o.href,u=I(n),s=a[u],i=x.EODASH_SENTINELHUB_CLIENT_ID,f=x.EODASH_SENTINELHUB_CLIENT_SECRET,d=await fe(i,f);if(!d){console.error("[eodash] Error while fetching bearer token from sentinel hub");return}const h=R(t.extent.temporal.interval[0],[a.start_date,a.end_date],a.distribution);return await Promise.all(h.map(([y,g])=>he({url:c,bearer:d,bbox:s,from:g,to:y,exampleLink:l}).catch(p=>console.error("[eodash] Error while fetching data from sentinel hub endpoint:",p)))).then(y=>y.flat().map(g=>g.outputs.data))}async function fe(e,a){if(!e||!a){console.error("[eodash] Error (sentinelhub): client id or secret not found");return}const n=sessionStorage.getItem("sentinelhub_token"),t=sessionStorage.getItem("sentinelhub_token_time"),r=Date.now()-Number(t)<3600*1e3;if(n&&r)return sessionStorage.setItem("sentinelhub_token_time",Date.now().toString()),n;const o=await pe(e,a);if(o)return sessionStorage.setItem("sentinelhub_token_time",Date.now().toString()),sessionStorage.setItem("sentinelhub_token",o),o}async function pe(e,a){const n="https://services.sentinel-hub.com/oauth/token",t={"Content-Type":"application/x-www-form-urlencoded"},r=new URLSearchParams({client_id:e,client_secret:a,response_type:"token",grant_type:"client_credentials"});return await v.post(n,r,{headers:t}).then(o=>o.data.access_token)}async function he({url:e,bearer:a,bbox:n,from:t,to:r,timeout:o=2e4,exampleLink:l}){if(!l){console.error("[eodash] Error (sentinelhub): example link not found in indicator");return}if(!n){console.error("[eodash] Error (sentinelhub): bbox not found");return}if(!t||!r||new Date(t)>new Date(r)){console.error("[eodash] Error (sentinelhub): time range is faulty or not found",t,r);return}const c=await v.get(l.href,{responseType:"text"}).then(i=>i.data);if(!c||c.error){console.error("[eodash] Error (sentinelhub): evalscript not found",c);return}const u={input:{bounds:{bbox:n},data:[{dataFilter:{},type:l.dataId}]},aggregation:{evalscript:c,timeRange:{from:t,to:r},aggregationInterval:{of:"P1D"},width:100,height:100},calculations:{default:{}}},s={headers:{Authorization:`Bearer ${a}`,"Content-Type":"application/json"},params:{credentials:"same-origin"},timeout:o};return await v.post(e,u,s).then(i=>{const f=i.data.data;return f.forEach(d=>{d.outputs.data.date=t}),f}).catch(i=>{if(i.response?.status===401){console.error("[eodash] Error (sentinelhub): bearer token expired, please try again"),sessionStorage.removeItem("sentinelhub_token"),sessionStorage.removeItem("sentinelhub_token_time");return}return console.error("[eodash] Error (sentinelhub): error while fetching data from sentinel hub",i.response?.data),[]})}async function ye(e,a){const n=e.links.find(t=>t.rel==="example"&&t.title==="evalscript");if(n)return n;for(const t of Q(e,a)){const r=v.get(t).then(o=>o.data.links.find(l=>l.rel==="example"&&l.title==="evalscript"));if(r)return r}}async function ge({links:e,jsonformSchema:a,jsonformValue:n,selectedStac:t,enableCompare:r=!1}){const o=e.find(i=>i.rel==="service"&&(i.endpoint==="veda"||i.endpoint==="veda_stac"));if(!o)return;const l=o?.href,c=I(a),u=JSON.parse(n[c]),s=await ve(t,r?_.value:A.value,o);return await Promise.all(s.map(({endpoint:i,datetime:f})=>{const d=new URL(l),h=o.endpoint==="veda_stac"?"ids":"url";return d.searchParams.set(h,i),v.post(d.toString(),{type:"Feature",properties:{},geometry:u}).then(y=>{const g=y.data.properties.statistics;return g.date=f,g}).catch(y=>console.error("[eodash] Error while fetching data from veda endpoint:",y))}))}async function ve(e,a,n){const t=e.links.filter(s=>s.rel=="child"),r=[];t.length?r.push(...await Promise.all(t.map(s=>v.get(T(s.href,a)).then(i=>i.data).then(async i=>{const f=Object.values(i.assets??{}).find(d=>d.type==="application/vnd.apache.parquet"&&d.roles?.includes("collection-mirror"));if(f){const d=T(f.href,T(s.href,a));await Y(d).then(h=>{i.links.push(...$(h))})}return i})))):r.push(e);const o=[];for(const s of r){const i=X(s.links),f=s.links.filter(d=>d.rel=="item");o.push(...f.map(d=>({endpoint:n.endpoint==="veda_stac"?d.id:d.cog_href,datetime:d[i]})))}o.sort((s,i)=>new Date(s.datetime).getTime()-new Date(i.datetime).getTime());const l=50;if(o.length<=l)return o;const c=o.length,u=[];for(let s=0;s<l;s++){const i=Math.floor(s*(c-1)/(l-1));u.push(o[i])}return u}const me=we([de,ge]);function we(e){return async a=>{for(const n of e){const t=await n(a);if(O.debug("Custom endpoint data:",t,"for callback:",n.name,"inputs:",a),!(!t||!t.length||t.some(o=>!o)))return t}return null}}async function Ie({selectedStac:e,jsonformEl:a,jsonformSchema:n,chartSpec:t,isProcessed:r,processResults:o,loading:l,isPolling:c,enableCompare:u}){const s=u?!!D.value:!!J.value;let i=null;if(e.value?.["eodash:jsonform"]&&(i=await v.get(e.value["eodash:jsonform"]).then(f=>f.data)),!i&&s){n.value=null;return}ke({loading:l,isProcessed:r,chartSpec:t,jsonformSchema:n,isPolling:c,processResults:o}),await a.value?.editor.destroy(),i&&(i.properties?.feature?.options?.drawtools?.layerId&&await be({jsonformSchema:n,newLayers:await Z()}),u&&(i=V(i)),n.value=i)}async function be({jsonformSchema:e,newLayers:a}){const n=e.value;if(!n)return;const t=W(n);if(t&&a&&n?.properties[t]?.options?.drawtools?.layerId){let r=a;a.layers&&Array.isArray(a.layers)&&(r=a.layers);const o=n.properties[t].options.drawtools.layerId.split(";:;")[0];let l=null;const c=u=>{if(u){for(const s of u)if(s.layers)c(s);else if(s.properties?.id?.startsWith(o)){l=s.properties.id;break}}};if(c(r),l)n.properties.feature.options.drawtools.layerId=l,e.value=null,await new Promise(u=>setTimeout(u,0)),e.value=n;else throw new Error(`Could not find matching layer for processing form with id: ${o}`)}}async function Pe({loading:e,selectedStac:a,jsonformEl:n,jsonformSchema:t,chartSpec:r,chartData:o,isPolling:l,processResults:c,mapElement:u,jobs:s}){if(!(!n.value||!t.value||!a.value)){O.debug("Processing..."),e.value=!0;try{const i=a.value?.links?.filter(m=>m.rel==="service"),f=I(t.value),d=n.value?.value;z(d,t.value);const h=d[f],y=a.value?.["eodash:vegadefinition"],g=a.value?.id??"";[r.value,o.value]=await j({links:i,jsonformValue:{...d??{}},jsonformSchema:t.value,enableCompare:u?.id==="compare",selectedStac:a.value,specUrl:y,isPolling:l,jobs:s,customEndpointsHandler:me}),Object.keys(o.value??{}).length&&c.value.push(o.value),r.value?.data?.values?.length&&c.value.push(r.value?.data.values),r.value&&!("background"in r.value)&&(r.value.background="transparent"),await se(i,d,u?.id==="compare");const p=await oe({isPolling:l,links:i,jsonformValue:{...d??{}},jsonformSchema:t.value,selectedStac:a.value,enableCompare:u?.id==="compare",layerId:g,origBbox:h,jobs:s,customLayersHandler:le,projection:a.value["eodash:mapProjection"]?.name});if(p.length)for(const m of p)m.type==="WebGLTile"&&m.source?.type==="GeoTIFF"?c.value.push(...m.source.sources??[]):m.source&&"url"in m.source&&c.value.push(m.source.url);K(u,p),e.value=!1}catch(i){throw console.error("[eodash] Error while running process:",i),e.value=!1,i}}}function ke({loading:e,isProcessed:a,chartSpec:n,jsonformSchema:t,processResults:r,isPolling:o}){e.value=!1,a.value=!1,o.value=!1,n.value=null,r.value=[],t.value=null}const Ce=e=>{const a=e.target?.spec;if(!a||!e.detail?.item?.datum||!e.detail?.item?.datum.datum)return;const n=Object.keys(a.encoding??{}).find(r=>a.encoding?.[r].type==="temporal");if(!n)return;const t=a.encoding?.[n].field;if(t)try{const r=e.detail.item;let o="";r.datum&&r.datum.datum?o=r.datum.datum[t]:o=r.datum[t];const l=new Date(o);H.value=l.toISOString()}catch(r){console.warn("[eodash] Error while setting datetime from eox-chart:",r)}},Ee=()=>{b.value||(b.value=new URLSearchParams(window.location.search).get("indicator")??"");const e=U(),a=e.stac?.find(n=>E(n)===b.value);if(e.loadSelectedSTAC(a?.href),D.value)if(L.value){const n=e.stac?.find(t=>E(t)===L.value);e.loadSelectedCompareSTAC(n?.href).catch(t=>{console.error("[eodash] Error loading compare STAC:",t)})}else e.resetSelectedCompareSTAC()};export{Pe as h,Ie as i,Ee as l,Ce as o,be as u};
