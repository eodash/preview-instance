import{ba as C,bb as L,r as R,bh as S,bc as g,ay as $,bg as B,aM as T,g as E,p as I,e as J,O as N,a as U,n as F,q as G,S as M,t as V,b as p,C as z,bi as A,ax as H,Y as W,a1 as w,Z as q,a3 as K,a4 as u,a0 as Y,$ as b,a7 as c,F as Z,a6 as Q,a9 as O,j as v,V as x,bj as X,bk as ee,bl as te}from"./index-zdRv8Ncz.js";import{g as se}from"./utils-sG5MXUTE.js";import{T as k}from"./index-DpObG0pT.js";function we(s){return Object.keys(s?.properties??{}).find(a=>s?.properties[a].format==="bounding-box")}function oe(s){return Object.keys(s?.properties??{}).filter(a=>s?.properties[a].type==="geojson")}function ve(s,a){const o=oe(a);for(const e of o)s[e]&&(se(a?.properties[e])?s[e]=s[e].features.map(t=>JSON.stringify(t.geometry)):s[e]=JSON.stringify(s[e].geometry))}async function ae(s,a,o,e,t){let n=null;"eox:flatstyle"in(s??{})&&(n=await C.get(s["eox:flatstyle"]).then(i=>i.data));let l,r;if(n){const i=L(a??"",n);l=i.layerConfig,r=i.style}o=o.sort();const d=o.length>0?{type:"WebGLTile",source:{type:"GeoTIFF",normalize:!r,sources:o.map(i=>({url:i}))},properties:{id:a+"_geotiff_process"+t,title:"Results "+a,...l&&{layerConfig:l},layerControlToolsExpand:!0},...r&&{style:r}}:void 0;return e&&d&&(d.source.projection=e),d}const ne=(s,a)=>{if(!a)return;let o=a;if(typeof a=="object"){a=JSON.stringify(a);const t=new Blob([a],{type:"text"});o=URL.createObjectURL(t)}const e=document.createElement("a");confirm(`Would you like to download ${s}?`)&&(e.href=o,e.download=s,e.click()),URL.revokeObjectURL(o),e.remove()};function xe(s,a,o){let e="",t="";[e,t]=a??["",""];const[n,l]=s??["",""];try{if(e&&t?(e=new Date(e),t=new Date(t)):(e=new Date(n),t=new Date(l)),(e<new Date(n)||e>new Date(l))&&(console.warn("[eodash] warn: start date is outside of the collection temporal extent and will be clamped",`
provided start date:${e.toISOString()}`,`
collection start date:${n}`),e=new Date(n)),(t>new Date(l)||t<new Date(n))&&(console.warn("[eodash] warn: end date is outside of the collection temporal extent and will be clamped",`
provided end date:${t.toISOString()}`,`
collection end date:${l}`),t=new Date(l)),e>t)return console.error("[eodash] Error: start date is greater than end date",e,t),[]}catch(f){return console.error("[eodash] Invalid date:",f.message),[]}const r=e.toISOString(),d=t.toISOString();if(!r||!d)return[];const i=[];let m=new Date(d);const P=new Date(r),y=24*60*60*1e3,j=o==="daily"?y:o==="weekly"?y*7:o==="monthly"?y*30:o==="yearly"?y*365:y;for(;m>=P&&i.length<31;)i.push(new Date(m)),m.setTime(m.getTime()-j);const D=[];for(let f=0;f<i.length-1;f++)D.push([i[f].toISOString(),i[f+1].toISOString()]);return D}function ke(s,a,o){if(!s)return[[],[]];const e=[],t=[];for(const n of s){const l=n.rel===a,r=o?n.type===o:!0;l&&r&&(n.endpoint?t.push(n):e.push(n))}return[e,t]}const h=R([]);async function Se({processUrl:s,isPolling:a,pollInterval:o=1e4,maxRetries:e=560}){let t=0;for(a.value=!0,setTimeout(()=>{_(h,g)},500);t<e&&a.value;){try{const n=new Date().getTime(),r=(await S.get(`${s}?t=${n}`)).data;if(r.status==="successful"){console.log("Process completed successfully. Fetching result item...");const d=r.links[1].href;if(!d)throw new Error("Result links not found in the process report.");const i=await S.get(d);return console.log("Result file fetched successfully:",i.data),i.data}if(r.status==="failed")throw a.value=!1,new Error("Process failed.",r);console.log(`Status: ${r.status}. Retrying in ${o/1e3} seconds...`)}catch(n){n instanceof Error?console.error("Error while polling process status:",n.message):console.error("Unknown error occurred:",n)}await new Promise(n=>setTimeout(n,o)),t++}if(!a.value)return console.warn("Polling was stopped before the process was completed."),JSON.parse("{}");throw new Error("Max retries reached. Process did not complete successfully.")}async function _(s,a){const o=JSON.parse(localStorage.getItem(a.value)||"[]"),e=await Promise.all(o.map(t=>fetch(t).then(n=>n.json())));e.sort((t,n)=>new Date(n.job_start_datetime).getTime()-new Date(t.job_start_datetime).getTime()),s.value=e}const re=async s=>{const o=JSON.parse(localStorage.getItem(g.value)||"[]").filter(e=>!e.includes(s.jobID));localStorage.setItem(g.value,JSON.stringify(o)),_(h,g)},le=async(s,a)=>{const o=[];await fetch(s.links[1].href).then(e=>e.json()).then(e=>{o.push(...e.urls)}),o.forEach(e=>{if(!e)return;let t="";typeof e=="string"?(t=e.includes("/")?e.split("/").pop()??"":e,t=t.includes("?")?t.split("?")[0]:t):t=a?.id+"_process_results.json",ne(t,e)})},ie=async(s,a)=>{const o=[];await S.get(s.links[1].href).then(e=>o.push(e.data)),await ce({selectedStac:a,results:o,jobId:s.jobID})};async function ce({selectedStac:s,results:a,jobId:o}){const e=s?.links.filter(n=>n.rel==="service"&&n.type==="image/tiff"),t=await ae(e?.[0],s?.id??"",a?.[0].urls,s?.["eodash:mapProjection"]?.name??null,o);if($.debug("rendered layers after loading previous process:",t),t){const n=[...t?[t]:[]];let l=[...B()];l.find(d=>d.properties.id.includes("AnalysisGroup"))?.layers.push(...n),T.value&&(T.value.layers=[...l])}}const de=I({fixedHeader:Boolean,fixedFooter:Boolean,height:[Number,String],hover:Boolean,...V(),...M(),...G(),...F()},"VTable"),ue=E()({name:"VTable",props:de(),setup(s,a){let{slots:o,emit:e}=a;const{themeClasses:t}=J(s),{densityClasses:n}=N(s);return U(()=>p(s.tag,{class:["v-table",{"v-table--fixed-height":!!s.height,"v-table--fixed-header":s.fixedHeader,"v-table--fixed-footer":s.fixedFooter,"v-table--has-top":!!o.top,"v-table--has-bottom":!!o.bottom,"v-table--hover":s.hover},t.value,n.value,s.class],style:s.style},{default:()=>[o.top?.(),o.default?p("div",{class:"v-table__wrapper",style:{height:z(s.height)}},[p("table",null,[o.default()])]):o.wrapper?.(),o.bottom?.()]})),{}}}),fe={style:{padding:"0px"}},pe={style:{padding:"0px"}},ye={style:{padding:"0px"}},ge={__name:"ProcessList",setup(s){const{selectedStac:a}=A(H());return W(()=>_(h,g)),(o,e)=>(b(),w("div",null,[u(h).length?(b(),q(ue,{key:0,density:"compact",style:{"background-color":"transparent"}},{default:Y(()=>[e[0]||(e[0]=c("thead",null,[c("tr",null,[c("th",{class:"text-left"},"Executed on"),c("th",{class:"text-left"},"Status"),c("th",{class:"text-left"}),c("th",{class:"text-left"}),c("th",{class:"text-left"})])],-1)),c("tbody",null,[(b(!0),w(Z,null,Q(u(h),t=>(b(),w("tr",{key:t.date},[c("td",null,O(new Date(t.job_start_datetime).toISOString().slice(0,16)),1),c("td",null,O(t.status),1),c("td",fe,[v(p(x,{disabled:t.status!=="successful",color:"primary",onClick:n=>u(ie)(t,u(a)),icon:[u(X)],variant:"text"},null,8,["disabled","onClick","icon"]),[[k,"Load results to map"]])]),c("td",pe,[v(p(x,{disabled:t.status!=="successful",color:"primary",onClick:n=>u(le)(t,u(a)),icon:[u(ee)],variant:"text"},null,8,["disabled","onClick","icon"]),[[k,"Download results"]])]),c("td",ye,[v(p(x,{color:"#ff5252",onClick:n=>u(re)(t),icon:[u(te)],variant:"text"},null,8,["onClick","icon"]),[[k,"Remove job"]])])]))),128))])]),_:1})):K("v-if",!0)]))}},_e=Object.freeze(Object.defineProperty({__proto__:null,default:ge},Symbol.toStringTag,{value:"Module"}));export{_e as P,ge as _,xe as a,ae as c,ne as d,ve as e,we as g,h as j,Se as p,ke as s,_ as u};
