import{e2 as g,dL as w,dH as E,az as P,e3 as N,d_ as S,d$ as b,e4 as I,e5 as A,e6 as U,e7 as H,aB as J,aA as O,dU as D,dT as G,e8 as C,aE as B}from"./index-BfirqpGG.js";import{s as L,c as F,p as R,e as q,u as x,a as z,g as T,b as V,f as $,h as K,i as M}from"./async-heEQufUu.js";async function Q({links:e,jsonformValue:r,specUrl:a,customEndpointsHandler:t,jsonformSchema:n,selectedStac:o,isPolling:l,jobs:u,enableCompare:s=!1}){if(!a||!e)return[null,null];const c=await g.get(a).then(p=>p.data),i={},[f,d]=L(e,"service",void 0),h=t&&r&&await t({jsonformSchema:n,jsonformValue:r,links:d,selectedStac:o,isPolling:l,jobs:u,enableCompare:s});if(h&&h.length)return c.data.values=h,[c,i];const y=f.filter(p=>p.rel==="service");try{e:for(const p of y??[])switch(p.type){case void 0:continue;case"application/json":await W(c,{url:p.href,jsonformValue:r,link:p,flatstyleUrl:p["eox:flatstyle"],jsonformSchema:n});break e;case"text/csv":await X(c,{url:p.href,jsonformValue:r,flatstyleUrl:p["eox:flatstyle"]});break e;default:break}}catch(p){console.error("[eodash] Error while injecting Vega data",p)}return[c,i]}async function W(e,{url:r,jsonformValue:a,link:t,flatstyleUrl:n,jsonformSchema:o}){if(e.data){if(t.method=="GET"){const l=o?.options?.multiQuery,u=Object.keys(a??{}).filter(c=>Array.isArray(l)?l.includes(c):l===c);if(u.length>0&&a){const c=[];for(const i of u)if(Array.isArray(a[i]))for(const f of a[i]){const d=await k(r,{...a,[i]:f},n);c.push(await g.get(d).then(h=>h.data))}else{const f=await k(r,a,n);c.push(await g.get(f).then(d=>d.data))}return e.data.values=c.flat(),e}const s=await k(r,a,n);e.data.values=await g.get(s).then(c=>c.data)}else if(t.method=="POST"){if(!t.body)return console.error("[eodash] Inline data POST request requires a body template"),e;const l=await g.get(t.body,{responseType:"text"}).then(s=>s.data),u=JSON.parse(w.render(l,{...a??{}}));e.data.values=await g.post(r,u).then(s=>s.data)}return e}}async function X(e,{url:r,jsonformValue:a,flatstyleUrl:t}){if(!e.data)return;const n=await k(r,a,t);return e.data.url=n,e}async function k(e,r,a){let t={};return a&&(t=await g.get(a).then(n=>n.data)),w.render(e,{...r??{},...t})}async function Y({links:e,jsonformValue:r,layerId:a,projection:t}){if(!e)return;const[n,o]=L(e,"service","image/tiff");if(!n.length)return;let l=[],u="";for(const c of n??[])l.push(w.render(c.href,{...r??{}}));return await Promise.all(n.map(c=>F(c,a,l,t,u))).then(c=>c.filter(i=>!!i))}function Z(e,r,a){if(!e)return;const t=e.filter(o=>o.rel==="service"&&o.type==="image/png"),n=[];for(const o of t)n.push({type:"Image",properties:{id:o.id+"_process",title:"Results "+o.id},source:{type:"ImageStatic",imageExtent:a,url:w.render(o.href,{...r??{}})}});return n}async function j(e,r,a){if(!e)return;const t=[],n=e.filter(l=>l.rel==="service"&&l.type==="application/geo+json");if(!n.length)return t;let o=null;for(const l of n){"eox:flatstyle"in(l??{})&&(o=await g.get(l["eox:flatstyle"]).then(i=>i.data));let u,s;if(o){const i=N(a??"",o);u=i.layerConfig,s=i.style}const c={type:"Vector",source:{type:"Vector",url:w.render(l.href,{...r??{}}),format:"GeoJSON"},properties:{id:l.id+"_process",title:"Results "+a,...u&&{...u}},...s&&{style:s}};t.push(c)}return t}async function ee({links:e,jsonformValue:r,layerId:a,projection:t,origBbox:n,isPolling:o,selectedStac:l,jsonformSchema:u,jobs:s,customLayersHandler:c,enableCompare:i=!1}){if(!e)return[];const f=[],[d,h]=L(e,"service",void 0);if(c&&r&&l&&u&&h.length>0){const v=await c({jsonformValue:r,links:h,selectedStac:l,isPolling:o,jsonformSchema:u,jobs:s,enableCompare:i});v.length&&f.push(...v)}const y=await j(d,r,a),p=Z(d,r,n),m=await Y({links:d,jsonformValue:r,layerId:a,projection:t});return f.push(...y??[],...p??[],...m??[]),f}async function te(e,r,a=!1){const t=e.find(u=>u.rel==="service"&&u.type=="application/json; profile=collection"&&u.endpoint==="STAC");if(!t)return;let n=w.render(t.href,{...r??{}});E.value&&(E.value=!1);const o=P();await(a?o.loadSelectedCompareSTAC:o.loadSelectedSTAC)(n,!0)}async function ne({links:e,jsonformValue:r,isPolling:a,selectedStac:t,jobs:n,enableCompare:o=!1}){if(!a)return;const l=e.filter(s=>s.rel==="service"&&s.endpoint==="eoxhub_workspaces"),u=[];for(const s of l){const c=await g.get(s.body,{responseType:"text"}).then(d=>d.data),i=JSON.parse(w.render(c,{...r??{}})),f=o?S:b;try{const d=await g.post(s.href,i,{headers:{"Content-Type":"application/json"}}),h=JSON.parse(localStorage.getItem(f.value)||"[]");h.push(d.headers.location),localStorage.setItem(f.value,JSON.stringify(h));const y=await R({jobs:n,processUrl:d.headers.location,isPolling:a,enableCompare:o}).then(p=>q(p)).catch(p=>(p instanceof Error?console.error("Polling failed:",p.message):console.error("Unknown error occurred during polling:",p),[]));await x(n,f.value),u.push(...await z(y,s,t))}catch(d){await x(n,f.value),d instanceof Error?console.error("Error sending POST request:",d.message):console.error("Unknown error occurred:",d)}}return u}const ae=re([ne]);function re(e){return async r=>await Promise.all(e.map(a=>a(r))).then(a=>{const t=[];for(const n of a)t.push(...n?.filter(oe)??[]);return t})}function oe(e){return!!e&&!!e.type&&(!!e.source||!!e.layers)}var _={};async function se({links:e,jsonformValue:r,jsonformSchema:a,selectedStac:t,enableCompare:n=!1}){const o=e.find(y=>y.rel==="service"&&y.endpoint==="sentinelhub");if(!o)return;const l=await ue(t,n?I.value:A.value);if(!l){console.error("[eodash] evalscript link for sentinel hub not found in indicator",l);return}if(!o)return;const u=o.href,s=T(a),c=r[s],i=_.EODASH_SENTINELHUB_CLIENT_ID,f=_.EODASH_SENTINELHUB_CLIENT_SECRET,d=await ie(i,f);if(!d){console.error("[eodash] Error while fetching bearer token from sentinel hub");return}const h=V(t.extent.temporal.interval[0],[r.start_date,r.end_date],r.distribution);return await Promise.all(h.map(([y,p])=>ce({url:u,bearer:d,bbox:c,from:p,to:y,exampleLink:l}).catch(m=>console.error("[eodash] Error while fetching data from sentinel hub endpoint:",m)))).then(y=>y.flat().map(p=>p.outputs.data))}async function ie(e,r){if(!e||!r){console.error("[eodash] Error (sentinelhub): client id or secret not found");return}const a=sessionStorage.getItem("sentinelhub_token"),t=sessionStorage.getItem("sentinelhub_token_time"),n=Date.now()-Number(t)<3600*1e3;if(a&&n)return sessionStorage.setItem("sentinelhub_token_time",Date.now().toString()),a;const o=await le(e,r);if(o)return sessionStorage.setItem("sentinelhub_token_time",Date.now().toString()),sessionStorage.setItem("sentinelhub_token",o),o}async function le(e,r){const a="https://services.sentinel-hub.com/oauth/token",t={"Content-Type":"application/x-www-form-urlencoded"},n=new URLSearchParams({client_id:e,client_secret:r,response_type:"token",grant_type:"client_credentials"});return await g.post(a,n,{headers:t}).then(o=>o.data.access_token)}async function ce({url:e,bearer:r,bbox:a,from:t,to:n,timeout:o=2e4,exampleLink:l}){if(!l){console.error("[eodash] Error (sentinelhub): example link not found in indicator");return}if(!a){console.error("[eodash] Error (sentinelhub): bbox not found");return}if(!t||!n||new Date(t)>new Date(n)){console.error("[eodash] Error (sentinelhub): time range is faulty or not found",t,n);return}const u=await g.get(l.href,{responseType:"text"}).then(i=>i.data);if(!u||u.error){console.error("[eodash] Error (sentinelhub): evalscript not found",u);return}const s={input:{bounds:{bbox:a},data:[{dataFilter:{},type:l.dataId}]},aggregation:{evalscript:u,timeRange:{from:t,to:n},aggregationInterval:{of:"P1D"},width:100,height:100},calculations:{default:{}}},c={headers:{Authorization:`Bearer ${r}`,"Content-Type":"application/json"},params:{credentials:"same-origin"},timeout:o};return await g.post(e,s,c).then(i=>{const f=i.data.data;return f.forEach(d=>{d.outputs.data.date=t}),f}).catch(i=>{if(i.response?.status===401){console.error("[eodash] Error (sentinelhub): bearer token expired, please try again"),sessionStorage.removeItem("sentinelhub_token"),sessionStorage.removeItem("sentinelhub_token_time");return}return console.error("[eodash] Error (sentinelhub): error while fetching data from sentinel hub",i.response?.data),[]})}async function ue(e,r){const a=e.links.find(t=>t.rel==="example"&&t.title==="evalscript");if(a)return a;for(const t of U(e,r)){const n=g.get(t).then(o=>o.data.links.find(l=>l.rel==="example"&&l.title==="evalscript"));if(n)return n}}async function de({links:e,jsonformSchema:r,jsonformValue:a,selectedStac:t,enableCompare:n=!1}){const o=e.find(i=>i.rel==="service"&&i.endpoint==="veda");if(!o)return;const l=o?.href,u=T(r),s=JSON.parse(a[u]),c=await fe(t,n?I.value:A.value);return await Promise.all(c.map(({endpoint:i,datetime:f})=>g.post(l+`?url=${i}`,{type:"Feature",properties:{},geometry:s}).then(d=>{const h=d.data.properties.statistics;return h.date=f,h}).catch(d=>console.error("[eodash] Error while fetching data from veda endpoint:",d))))}async function fe(e,r){const a=e.links.filter(s=>s.rel=="child"),t=[];a.length?t.push(...await Promise.all(a.map(s=>g.get(H(s.href,r)).then(c=>c.data)))):t.push(e);const n=[];for(const s of t){const c=J(s.links);let i=s.links.filter(f=>f.rel=="item");n.push(...i.map(f=>({endpoint:f.cog_href,datetime:f[c]})))}n.sort((s,c)=>new Date(s.datetime).getTime()-new Date(c.datetime).getTime());const o=50;if(n.length<=o)return n;const l=n.length,u=[];for(let s=0;s<o;s++){const c=Math.floor(s*(l-1)/(o-1));u.push(n[c])}return u}const pe=he([se,de]);function he(e){return async r=>{for(const a of e){const t=await a(r);if(O.debug("Custom endpoint data:",t,"for callback:",a.name,"inputs:",r),!(!t||!t.length||t.some(o=>!o)))return t}return null}}async function me({selectedStac:e,jsonformEl:r,jsonformSchema:a,chartSpec:t,isProcessed:n,processResults:o,loading:l,isPolling:u,enableCompare:s}){const c=s?!!D.value:!!G.value;let i=null;if(e.value?.["eodash:jsonform"]&&(i=await g.get(e.value["eodash:jsonform"]).then(f=>f.data)),!i&&c){a.value=null;return}ge({loading:l,isProcessed:n,chartSpec:t,jsonformSchema:a,isPolling:u,processResults:o}),await r.value?.editor.destroy(),i&&(s&&(i=$(i)),a.value=i)}async function we({loading:e,selectedStac:r,jsonformEl:a,jsonformSchema:t,chartSpec:n,chartData:o,isPolling:l,processResults:u,mapElement:s,jobs:c}){if(!(!a.value||!t.value||!r.value)){O.debug("Processing..."),e.value=!0;try{const i=r.value?.links?.filter(v=>v.rel==="service"),f=T(t.value),d=a.value?.value;K(d,t.value);const h=d[f],y=r.value?.["eodash:vegadefinition"],p=r.value?.id??"";[n.value,o.value]=await Q({links:i,jsonformValue:{...d??{}},jsonformSchema:t.value,enableCompare:s?.id==="compare",selectedStac:r.value,specUrl:y,isPolling:l,jobs:c,customEndpointsHandler:pe}),Object.keys(o.value??{}).length&&u.value.push(o.value),n.value?.data?.values?.length&&u.value.push(n.value?.data.values),n.value&&!("background"in n.value)&&(n.value.background="transparent"),await te(i,d,s?.id==="compare");const m=await ee({isPolling:l,links:i,jsonformValue:{...d??{}},jsonformSchema:t.value,selectedStac:r.value,enableCompare:s?.id==="compare",layerId:p,origBbox:h,jobs:c,customLayersHandler:ae,projection:r.value["eodash:mapProjection"]?.name});if(m.length)for(const v of m)v.type==="WebGLTile"&&v.source?.type==="GeoTIFF"?u.value.push(...v.source.sources??[]):v.source&&"url"in v.source&&u.value.push(v.source.url);M(s,m),e.value=!1}catch(i){throw console.error("[eodash] Error while running process:",i),e.value=!1,i}}}function ge({loading:e,isProcessed:r,chartSpec:a,jsonformSchema:t,processResults:n,isPolling:o}){e.value=!1,r.value=!1,o.value=!1,a.value=null,n.value=[],t.value=null}const be=e=>{const r=e.target?.spec;if(!r||!e.detail?.item?.datum||!e.detail?.item?.datum.datum)return;const a=Object.keys(r.encoding??{}).find(n=>r.encoding?.[n].type==="temporal");if(!a)return;const t=r.encoding?.[a].field;if(t)try{const n=e.detail.item;let o="";n.datum&&n.datum.datum?o=n.datum.datum[t]:o=n.datum[t];const l=new Date(o);B.value=l.toISOString()}catch(n){console.warn("[eodash] Error while setting datetime from eox-chart:",n)}},ke=()=>{b.value||(b.value=new URLSearchParams(window.location.search).get("indicator")??"");const e=P(),r=e.stac?.find(a=>C(a)===b.value);if(e.loadSelectedSTAC(r?.href),D.value)if(S.value){const a=e.stac?.find(t=>C(t)===S.value);e.loadSelectedCompareSTAC(a?.href).catch(t=>{console.error("[eodash] Error loading compare STAC:",t)})}else e.resetSelectedCompareSTAC()};export{we as h,me as i,ke as l,be as o};
