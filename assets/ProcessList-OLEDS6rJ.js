import{bp as j,bq as C,r as R,bw as k,bn as g,ay as $,bs as B,aN as T,g as E,p as I,e as N,P as J,a as U,n as F,q as G,S as M,v as V,b as p,D as z,bx as A,ax as q,b9 as H,a1 as w,Z as W,a3 as K,a4 as u,a0 as Z,$ as b,a7 as c,F as Q,a6 as X,a9 as P,j as v,V as x,by as Y,bz as ee,bA as te}from"./index-ofgZE0U6.js";import{g as se}from"./utils-sG5MXUTE.js";import{T as S}from"./index-CzvEtOHt.js";function we(s){return Object.keys(s?.properties??{}).find(o=>s?.properties[o].format==="bounding-box")}function ae(s){return Object.keys(s?.properties??{}).filter(o=>s?.properties[o].type==="geojson")}function ve(s,o){const a=ae(o);for(const e of a)s[e]&&(se(o?.properties[e])?s[e]=s[e].features.map(t=>JSON.stringify(t.geometry)):s[e]=JSON.stringify(s[e].geometry))}async function oe(s,o,a,e,t){let n=null;"eox:flatstyle"in(s??{})&&(n=await j.get(s["eox:flatstyle"]).then(i=>i.data));let l,r;if(n){const i=C(o??"",n);l=i.layerConfig,r=i.style}a=a.sort();const d=a.length>0?{type:"WebGLTile",source:{type:"GeoTIFF",normalize:!r,sources:a.map(i=>({url:i}))},properties:{id:s.id+"_process"+t,title:"Results "+o,...l&&{layerConfig:l},layerControlToolsExpand:!0},...r&&{style:r}}:void 0;return e&&d&&(d.source.projection=e),d}const ne=(s,o)=>{if(!o)return;let a=o;if(typeof o=="object"){o=JSON.stringify(o);const t=new Blob([o],{type:"text"});a=URL.createObjectURL(t)}const e=document.createElement("a");confirm(`Would you like to download ${s}?`)&&(e.href=a,e.download=s,e.click()),URL.revokeObjectURL(a),e.remove()};function xe(s,o,a){let e="",t="";[e,t]=o??["",""];const[n,l]=s??["",""];try{if(e&&t?(e=new Date(e),t=new Date(t)):(e=new Date(n),t=new Date(l)),(e<new Date(n)||e>new Date(l))&&(console.warn("[eodash] warn: start date is outside of the collection temporal extent and will be clamped",`
provided start date:${e.toISOString()}`,`
collection start date:${n}`),e=new Date(n)),(t>new Date(l)||t<new Date(n))&&(console.warn("[eodash] warn: end date is outside of the collection temporal extent and will be clamped",`
provided end date:${t.toISOString()}`,`
collection end date:${l}`),t=new Date(l)),e>t)return console.error("[eodash] Error: start date is greater than end date",e,t),[]}catch(f){return console.error("[eodash] Invalid date:",f.message),[]}const r=e.toISOString(),d=t.toISOString();if(!r||!d)return[];const i=[];let m=new Date(d);const O=new Date(r),y=24*60*60*1e3,L=a==="daily"?y:a==="weekly"?y*7:a==="monthly"?y*30:a==="yearly"?y*365:y;for(;m>=O&&i.length<31;)i.push(new Date(m)),m.setTime(m.getTime()-L);const _=[];for(let f=0;f<i.length-1;f++)_.push([i[f].toISOString(),i[f+1].toISOString()]);return _}function Se(s,o,a){if(!s)return[[],[]];const e=[],t=[];for(const n of s){const l=n.rel===o,r=a?n.type===a:!0;l&&r&&(n.endpoint?t.push(n):e.push(n))}return[e,t]}const h=R([]);async function ke({processUrl:s,isPolling:o,pollInterval:a=1e4,maxRetries:e=560}){let t=0;for(o.value=!0,setTimeout(()=>{D(h,g)},500);t<e&&o.value;){try{const n=new Date().getTime(),r=(await k.get(`${s}?t=${n}`)).data;if(r.status==="successful"){console.log("Process completed successfully. Fetching result item...");const d=r.links[1].href;if(!d)throw new Error("Result links not found in the process report.");const i=await k.get(d);return console.log("Result file fetched successfully:",i.data),i.data}if(r.status==="failed")throw o.value=!1,new Error("Process failed.",r);console.log(`Status: ${r.status}. Retrying in ${a/1e3} seconds...`)}catch(n){n instanceof Error?console.error("Error while polling process status:",n.message):console.error("Unknown error occurred:",n)}await new Promise(n=>setTimeout(n,a)),t++}if(!o.value)return console.warn("Polling was stopped before the process was completed."),JSON.parse("{}");throw new Error("Max retries reached. Process did not complete successfully.")}async function D(s,o){const a=JSON.parse(localStorage.getItem(o.value)||"[]"),e=await Promise.all(a.map(t=>fetch(t).then(n=>n.json())));e.sort((t,n)=>new Date(n.job_start_datetime).getTime()-new Date(t.job_start_datetime).getTime()),s.value=e}const re=async s=>{const a=JSON.parse(localStorage.getItem(g.value)||"[]").filter(e=>!e.includes(s.jobID));localStorage.setItem(g.value,JSON.stringify(a)),D(h,g)},le=async(s,o)=>{const a=[];await fetch(s.links[1].href).then(e=>e.json()).then(e=>{a.push(...e.urls)}),a.forEach(e=>{if(!e)return;let t="";typeof e=="string"?(t=e.includes("/")?e.split("/").pop()??"":e,t=t.includes("?")?t.split("?")[0]:t):t=o?.id+"_process_results.json",ne(t,e)})},ie=async(s,o)=>{const a=[];await k.get(s.links[1].href).then(e=>a.push(e.data)),await ce({selectedStac:o,results:a,jobId:s.jobID})};async function ce({selectedStac:s,results:o,jobId:a}){const e=s?.links.filter(n=>n.rel==="service"&&n.type==="image/tiff"),t=await oe(e?.[0],s?.id??"",o?.[0].urls,s?.["eodash:mapProjection"]?.name??null,a);if($.debug("rendered layers after loading previous process:",t),t){const n=[...t?[t]:[]];let l=[...B()];l.find(d=>d.properties?.id.includes("AnalysisGroup"))?.layers.push(...n),T.value&&(T.value.layers=[...l])}}const de=I({fixedHeader:Boolean,fixedFooter:Boolean,height:[Number,String],hover:Boolean,...V(),...M(),...G(),...F()},"VTable"),ue=E()({name:"VTable",props:de(),setup(s,o){let{slots:a,emit:e}=o;const{themeClasses:t}=N(s),{densityClasses:n}=J(s);return U(()=>p(s.tag,{class:["v-table",{"v-table--fixed-height":!!s.height,"v-table--fixed-header":s.fixedHeader,"v-table--fixed-footer":s.fixedFooter,"v-table--has-top":!!a.top,"v-table--has-bottom":!!a.bottom,"v-table--hover":s.hover},t.value,n.value,s.class],style:s.style},{default:()=>[a.top?.(),a.default?p("div",{class:"v-table__wrapper",style:{height:z(s.height)}},[p("table",null,[a.default()])]):a.wrapper?.(),a.bottom?.()]})),{}}}),fe={style:{padding:"0px"}},pe={style:{padding:"0px"}},ye={style:{padding:"0px"}},ge={__name:"ProcessList",setup(s){const{selectedStac:o}=A(q());return H(()=>D(h,g)),(a,e)=>(b(),w("div",null,[u(h).length?(b(),W(ue,{key:0,density:"compact",style:{"background-color":"transparent"}},{default:Z(()=>[e[0]||(e[0]=c("thead",null,[c("tr",null,[c("th",{class:"text-left"},"Executed on"),c("th",{class:"text-left"},"Status"),c("th",{class:"text-left"}),c("th",{class:"text-left"}),c("th",{class:"text-left"})])],-1)),c("tbody",null,[(b(!0),w(Q,null,X(u(h),t=>(b(),w("tr",{key:t.date},[c("td",null,P(new Date(t.job_start_datetime).toISOString().slice(0,16)),1),c("td",null,P(t.status),1),c("td",fe,[v(p(x,{disabled:t.status!=="successful",color:"primary",onClick:n=>u(ie)(t,u(o)),icon:[u(Y)],variant:"text"},null,8,["disabled","onClick","icon"]),[[S,"Load results to map"]])]),c("td",pe,[v(p(x,{disabled:t.status!=="successful",color:"primary",onClick:n=>u(le)(t,u(o)),icon:[u(ee)],variant:"text"},null,8,["disabled","onClick","icon"]),[[S,"Download results"]])]),c("td",ye,[v(p(x,{color:"#ff5252",onClick:n=>u(re)(t),icon:[u(te)],variant:"text"},null,8,["onClick","icon"]),[[S,"Remove job"]])])]))),128))])]),_:1})):K("v-if",!0)]))}},De=Object.freeze(Object.defineProperty({__proto__:null,default:ge},Symbol.toStringTag,{value:"Module"}));export{De as P,ge as _,xe as a,oe as c,ne as d,ve as e,we as g,h as j,ke as p,Se as s,D as u};
